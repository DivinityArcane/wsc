var Chatterbox={};Chatterbox.VERSION="0.4.4";Chatterbox.STATE="beta";Chatterbox.UI=function(a,b,e,c){this.events=c||new EventEmitter();this.mozilla=e;this.settings={themes:["wsct_default","wsct_dAmn"],theme:"wsct_default",monitor:["~Monitor",true],username:"",domain:"website.com"};a.extend(this.settings,b);a.append('<div class="wsc '+this.settings.theme+'"></div>');this.view=a.find(".wsc");this.mns=this.format_ns(this.settings.monitor[0]);this.lun=this.settings.username.toLowerCase();this.monitoro=null;this.swidth=getscrollbarWidth();this.LIB="Chatterbox";this.VERSION=Chatterbox.VERSION;this.STATE=Chatterbox.STATE};Chatterbox.UI.prototype.trigger=function(a,b){this.events.emit(a,b,this)};Chatterbox.UI.prototype.on=function(b,a){this.events.addListener(b,a)};Chatterbox.UI.prototype.remove_listeners=function(){this.events.removeListeners()};Chatterbox.UI.prototype.deform_ns=function(a){if(a.indexOf("chat:")==0){return"#"+a.slice(5)}if(a.indexOf("server:")==0){return"~"+a.slice(7)}if(a.indexOf("pchat:")==0){var b=a.split(":");
b.shift();for(i in b){name=b[i];if(name.toLowerCase()!=this.lun){return"@"+name}}}if(a.indexOf("login:")==0){return"@"+a.slice(6)}if(a[0]!="#"&&a[0]!="@"&&a[0]!="~"){return"#"+a}return a};Chatterbox.UI.prototype.format_ns=function(a){if(a.indexOf("#")==0){return"chat:"+a.slice(1)}if(a.indexOf("@")==0){var b=[a.slice(1),this.lun];b.sort(caseInsensitiveSort);b.unshift("pchat");return b.join(":")}if(a.indexOf("~")==0){return"server:"+a.slice(1)}if(a.indexOf("chat:")!=0&&a.indexOf("server:")!=0&&a.indexOf("pchat:")!=0){return"chat:"+a}return a};Chatterbox.UI.prototype.set_events=function(a){this.events=a||this.events};Chatterbox.UI.prototype.build=function(c,a,b){this.view.append(Chatterbox.template.ui);this.control=new (c||Chatterbox.Control)(this);this.nav=new (a||Chatterbox.Navigation)(this);this.chatbook=new (b||Chatterbox.Chatbook)(this);hide=this.settings.monitor[1];this.monitoro=this.chatbook.create_channel(this.mns,hide,true);this.control.focus()};Chatterbox.UI.prototype.resize=function(){this.control.resize();
this.view.height(this.view.parent().height());this.nav.resize();this.chatbook.resize(this.view.parent().height()-this.nav.height()-this.control.height())};Chatterbox.UI.prototype.create_channel=function(b,a){this.chatbook.create_channel(b,a)};Chatterbox.UI.prototype.remove_channel=function(a){this.chatbook.remove_channel(a)};Chatterbox.UI.prototype.toggle_channel=function(a){return this.chatbook.toggle_channel(a)};Chatterbox.UI.prototype.channel=function(a,b){return this.chatbook.channel(a,b)};Chatterbox.UI.prototype.channels=function(){return this.chatbook.channels()};Chatterbox.UI.prototype.monitor=function(b,a){this.monitoro.server_message(b,a)};Chatterbox.UI.prototype.server_message=function(b,a){this.chatbook.server_message(b,a)};Chatterbox.UI.prototype.log_item=function(a){this.chatbook.log_item(a)};Chatterbox.UI.prototype.log=function(a){this.chatbook.log_item(wsc_html_logmsg.replacePArg("{message}",a))};Chatterbox.UI.prototype.theme=function(a){if(this.settings.theme==a){return}if(this.settings.themes.indexOf(a)==-1){a="wsct_"+a;
if(this.settings.themes.indexOf(a)==-1){return}}this.view.removeClass(this.settings.theme).addClass(a);this.settings.theme=a};Chatterbox.UI.prototype.add_theme=function(a){if(this.settings.themes.indexOf(a)>-1){return}this.settings.themes.push(a)};Chatterbox.Channel=function(f,c,e,b){var a=f.deform_ns(c).slice(1).toLowerCase();this.manager=f;this.hidden=e;this.monitor=b||false;this.built=false;this.selector=a;this.raw=f.format_ns(c);this.namespace=f.deform_ns(c)};Chatterbox.Channel.prototype.build=function(){if(this.built){return}var a=this.selector;ns=this.namespace;this.tab=this.manager.nav.add_tab(a,ns);this.tabl=this.tab.find(".tab");this.tabc=this.tab.find(".close");this.manager.chatbook.view.append(Chatterbox.render("channel",{selector:a,ns:ns}));this.window=this.manager.chatbook.view.find("#"+a+"-window");this.logpanel=this.window.find("#"+a+"-log");this.wrap=this.logpanel.find("ul.logwrap");this.userpanel=this.window.find("#"+a+"-users");var c=this;this.tabl.click(function(){c.manager.toggle_channel(a);
return false});this.tabc.click(function(f){c.manager.trigger("tab.close.clicked",{ns:c.namespace,chan:c,e:f})});var b=true;this.window.click(function(f){if(b){c.manager.control.focus()}else{b=true}});this.logpanel.select(function(){b=false});if(this.hidden){this.tab.toggleClass("hidden")}this.built=true};Chatterbox.Channel.prototype.hide=function(){this.window.css({display:"none"});this.tab.removeClass("active")};Chatterbox.Channel.prototype.show=function(){this.window.css({display:"block"});this.tab.addClass("active");this.tab.removeClass("noise tabbed fill");this.resize()};Chatterbox.Channel.prototype.remove=function(){this.tab.remove();this.window.remove()};Chatterbox.Channel.prototype.scroll=function(){this.pad();this.wrap.scrollTop(this.wrap.prop("scrollHeight")-this.wrap.innerHeight())};Chatterbox.Channel.prototype.pad=function(){this.wrap.css({"padding-top":0});wh=this.wrap.innerHeight();lh=this.logpanel.innerHeight()-this.logpanel.find("header").height()-3;pad=lh-wh;if(pad>0){this.wrap.css({"padding-top":pad})
}else{this.wrap.css({"padding-top":0,height:lh})}};Chatterbox.Channel.prototype.resize=function(){this.wrap.css({"padding-top":0});wh=this.manager.chatbook.height();this.window.height(wh);cw=this.window.width();cu=this.window.find("div.chatusers");title=this.window.find("header div.title");topic=this.window.find("header div.topic");if(cu.css("display")!="none"){cu.width(1);userwidth=cu[0].scrollWidth+this.manager.swidth+10;max=parseInt(cu.css("max-width").slice(0,-2));if(userwidth>max){userwidth=max}cu.width(userwidth);cw=cw-cu.outerWidth()}if(title.css("display")=="block"){wh=wh-title.outerHeight(true)}this.logpanel.css({height:wh-3,width:cw});this.scroll();cu.css({height:this.logpanel.innerHeight()-3})};Chatterbox.Channel.prototype.log=function(a){data={ns:this.namespace,message:a};this.manager.trigger("log.before",data);this.log_item(Chatterbox.render("logmsg",{message:data.message}))};Chatterbox.Channel.prototype.log_item=function(b){var a=new Date().toTimeString().slice(0,8);data={ts:a,message:b};
this.manager.trigger("log_item.before",data);this.wrap.append(Chatterbox.render("logitem",{ts:data.ts,message:data.message}));this.manager.trigger("log_item.after",{item:this.wrap.find("li").last()});this.scroll();this.noise()};Chatterbox.Channel.prototype.server_message=function(b,a){data={ns:this.namespace,message:b,info:a};this.manager.trigger("server_message.before",data);this.log_item(Chatterbox.render("servermsg",{message:data.message,info:data.info}))};Chatterbox.Channel.prototype.clear=function(){this.logpanel.find("li.logmsg").remove();this.resize()};Chatterbox.Channel.prototype.log_info=function(b,a){data={ns:this.namespace,ref:b,content:a};this.manager.trigger("log_info.before",data);delete data.ns;this.wrap.append(Chatterbox.render("loginfobox",data));this.scroll();var c=this;this.wrap.find("li."+data.ref).find("a.close").click(function(f){c.wrap.find(this).parent().remove();c.resize();c.scroll()})};Chatterbox.Channel.prototype.show_whois=function(b){console.log(b);var e={avatar:'<a href="#"><img height="50" width="50" alt="avatar"/></a>',username:b.symbol+b.username,info:[b.realname],conns:[],raw:b,};
for(i in b.connections){rcon=b.connections[i];e.conns.push([["online",rcon.online],["idle",rcon.idle],["chatrooms",rcon.channels.join(" ")]])}this.manager.trigger("log_whois.before",e);var a="";for(i in e.conns){conn=e.conns[i];text='<section class="conn"><p><em>connection '+((parseInt(i)+1).toString())+":</em></p>";text+="<ul>";for(x in conn){text+="<li><strong>"+conn[x][0]+":</strong> "+conn[x][1]+"</li>"}text+="</ul>";a+=text+"</section>"}var c="";for(i in e.info){c+="<li>"+e.info[i]+"</li>"}this.log_info("whois-"+b.username,Chatterbox.render("whoiswrap",{avatar:e.avatar,info:Chatterbox.render("whoisinfo",{username:e.username,info:c,connections:a})}))};Chatterbox.Channel.prototype.set_header=function(a,b){headd=this.window.find("header div."+a);headd.replaceWith(Chatterbox.render("header",{head:a,content:b||""}));headd=this.window.find("header div."+a);if(b){headd.css({display:"block"})}else{this.window.find("header div."+a).css({display:"none"})}this.resize()};Chatterbox.Channel.prototype.get_header=function(a){return this.window.find("header div."+a)
};Chatterbox.Channel.prototype.set_user_list=function(a){if(Object.size(a)==0){return}infoboxes=[];html="";for(order in a){pc=a[order];html+='<div class="pc"><h3>'+pc.name+"</h3><ul>";for(un in pc.users){user=pc.users[un];conn=user.conn==1?"":"["+user.conn+"]";html+='<li><a target="_blank" id="'+user.name+'" href="http://'+user.name+"."+this.manager.settings.domain+'"><em>'+user.symbol+"</em>"+user.name+"</a>"+conn+"</li>";if(user.hover){infoboxes.push(user.hover)}}html+="</ul></div>"}this.window.find("div.chatusers").html(html);this.userpanel=this.window.find("div.chatusers");this.userpanel.css({display:"block"});for(index in infoboxes){this.userinfo(infoboxes[index])}this.resize()};Chatterbox.Channel.prototype.highlight=function(c){var a=this.tab;(c||this.window.find(".logmsg").last()).addClass("highlight");if(a.hasClass("active")){return}if(a.hasClass("tabbed")){return}var e=0;a.addClass("tabbed");function b(){e++;a.toggleClass("fill");if(e==6){return}setTimeout(b,1000)}b()};Chatterbox.Channel.prototype.noise=function(){if(!this.tab.hasClass("active")){this.tab.addClass("noise")
}};Chatterbox.Channel.prototype.userinfo=function(a){var c=this.window.find("a#"+a.name);if(c.length==0){return}var e=this;var b=null;c.hover(function(f){a.info=[];ed={ns:e.namespace,user:a};e.manager.trigger("userinfo.before",ed);a=ed.user;infoli="";for(index in a.info){infoli+="<li>"+a.info[index]+"</li>"}e.window.append(Chatterbox.render("userinfo",{username:a.name,avatar:a.avatar,link:a.link,info:infoli}));b=e.window.find(".userinfo#"+a.name);e.window.find("div.userinfo:not('#"+a.name+"')").remove();pos=c.offset();b.css({top:(pos.top-c.height())+10,left:(pos.left-(b.width()))-6});b.find(".info").height(b.height());b.hover(function(){b.data("hover",1)},function(g){b.data("hover",0);e.unhover_user(b,event)});b.data("hover",0)},function(f){c.data("hover",0);e.unhover_user(b,event)})};Chatterbox.Channel.prototype.unhover_user=function(b,a){o=b.offset();eb=b.outerHeight(true)+o.top;er=b.outerWidth(true)+o.left;x=a.pageX;y=a.pageY;if(x>o.left&&x<er&&y>o.top&&y<eb){return}if(x<(er+15)&&x>o.left&&y>o.top&&y<(o.top+15)){return
}b.remove()};Chatterbox.Chatbook=function(a){this.manager=a;this.view=this.manager.view.find("div.chatbook");this.chan={};this.trail=[];this.current=null;this.manager.on("tab.close.clicked",function(b,c){c.chatbook.remove_channel(b.ns)})};Chatterbox.Chatbook.prototype.height=function(){return this.view.height()};Chatterbox.Chatbook.prototype.resize=function(a){a=a||600;this.view.height(a);for(select in this.chan){var b=this.chan[select];b.resize()}};Chatterbox.Chatbook.prototype.channel=function(a,b){a=this.manager.deform_ns(a).slice(1).toLowerCase();if(!this.chan[a]&&b){this.chan[a]=b}return this.chan[a]};Chatterbox.Chatbook.prototype.channels=function(){chans=-1;for(ns in this.chan){if(this.chan[ns].hidden){continue}chans++}return chans};Chatterbox.Chatbook.prototype.create_channel=function(b,c,a){chan=this.channel(b,this.channel_object(b,c,a));chan.build();this.toggle_channel(b);this.manager.resize();return chan};Chatterbox.Chatbook.prototype.channel_object=function(a,b){return new Chatterbox.Channel(this.manager,a,b)
};Chatterbox.Chatbook.prototype.toggle_channel=function(a){chan=this.channel(a);prev=chan;if(!chan){return}if(this.current){if(this.current==chan){return}this.current.hide();prev=this.current}chan.show();this.manager.control.focus();this.current=chan;this.manager.resize();pos=this.trail.indexOf(chan.namespace);if(pos>=0){this.trail.splice(pos,1)}this.trail.push(chan.namespace);this.manager.trigger("channel.selected",{ns:chan.namespace,chan:chan,prev:prev})};Chatterbox.Chatbook.prototype.remove_channel=function(a){if(this.channels()==0){return}chan=this.channel(a);chan.remove();delete this.chan[chan.selector];rpos=this.trail.indexOf(chan.namespace);this.trail.splice(rpos,1);if(this.current!=chan){return}select=this.trail[this.trail.length-1];this.toggle_channel(select);this.channel(select).resize()};Chatterbox.Chatbook.prototype.server_message=function(b,a){for(ns in this.chan){this.chan[ns].server_message(b,a)}};Chatterbox.Chatbook.prototype.log_item=function(a){for(ns in this.chan){this.chan[ns].log_item(a)
}};Chatterbox.Control=function(a){this.manager=a;this.manager.view.append(Chatterbox.template.control);this.view=this.manager.view.find("div.chatcontrol");this.form=this.view.find("form.msg");this.input=this.form.find("input.msg")};Chatterbox.Control.prototype.focus=function(){this.input.focus()};Chatterbox.Control.prototype.resize=function(){w=this.manager.view.width();this.view.css({width:"100%"});this.form.css({width:this.manager.view.width()-20});this.input.css({width:this.manager.view.width()-80})};Chatterbox.Control.prototype.height=function(){return this.view.height()};Chatterbox.Control.prototype.set_handlers=function(b,a){if(this.manager.mozilla){this.input.keypress(b||this._onkeypress)}else{this.input.keydown(b||this._onkeypress)}this.form.submit(a||this._onsubmit)};Chatterbox.Control.prototype._onkeypress=function(a){};Chatterbox.Control.prototype._onsubmit=function(a){};Chatterbox.Control.prototype.chomp=function(){d=this.input.val();i=d.lastIndexOf(" ");if(i==-1){this.input.val("");
return d}chunk=d.slice(i+1);this.input.val(d.slice(0,i));if(chunk.length==0){return this.chomp()}return chunk};Chatterbox.Control.prototype.unchomp=function(a){d=this.input.val();if(!d){this.input.val(a)}else{this.input.val(d+" "+a)}};Chatterbox.Control.prototype.get_text=function(){return this.input.val()};Chatterbox.Control.prototype.set_text=function(a){this.input.val(a||"")};Chatterbox.Navigation=function(a){this.manager=a;this.nav=this.manager.view.find("nav.tabs");this.tabs=this.nav.find("#chattabs");this.buttons=this.nav.find("#tabnav");this.tableft=this.buttons.find(".arrow_left");this.tabright=this.buttons.find(".arrow_right");this.settings=this.buttons.find(".cog")};Chatterbox.Navigation.prototype.height=function(){return this.nav.height()};Chatterbox.Navigation.prototype.add_tab=function(a,b){this.tabs.append(Chatterbox.render("tab",{selector:a,ns:b}));return this.tabs.find("#"+a+"-tab")};Chatterbox.Navigation.prototype.resize=function(){this.tabs.width(this.nav.width()-this.buttons.outerWidth()-20)
};Chatterbox.template={};Chatterbox.render=function(a,b){if(!Chatterbox.template.hasOwnProperty(a)){return""}html=Chatterbox.template[a];for(key in b){if(!b.hasOwnProperty(key)){continue}html=replaceAll(html,"{"+key+"}",b[key])}return html};Chatterbox.template.ui='<nav class="tabs"><ul id="chattabs"></ul>        <ul id="tabnav">            <li><a href="#left" class="button iconic arrow_left"></a></li>            <li><a href="#right" class="button iconic arrow_right"></a></li>            <li><a href="#settings" title="Change client settings" class="button iconic cog"></a></li>        </ul>        </nav>        <div class="chatbook"></div>';Chatterbox.template.control='<div class="chatcontrol">            <p><a href="#multiline" title="Toggle multiline input" class="button iconic list"></a></p>            <form class="msg">                <input type="text" class="msg" />                <input type="submit" value="Send" class="sendmsg" />            </form>        </div>';Chatterbox.template.tab='<li id="{selector}-tab"><a href="#{selector}" class="tab">{ns}<a href="#{selector}" class="close iconic x"></a></a></li>';
Chatterbox.template.channel='<div class="chatwindow" id="{selector}-window">                    <header>                        <div class="title"></div>                    </header>                    <div class="chatlog" id="{selector}-log">                        <header>                            <div class="topic"></div>                        </header>                        <ul class="logwrap"></ul>                    </div>                    <div class="chatusers" id="{selector}-users">                </div>            </div>';Chatterbox.template.header='<div class="{head}">{content}</div>';Chatterbox.template.logmsg='<span class="message">{message}</span>';Chatterbox.template.logitem='<li class="logmsg"><span class="ts">{ts}</span> {message}</li>';Chatterbox.template.servermsg='<span class="servermsg">** {message} * <em>{info}</em></span>';Chatterbox.template.usermsg='<strong class="user">&lt;{user}&gt;</strong> {message}';Chatterbox.template.userinfo='<div class="userinfo" id="{username}">                            <div class="avatar">                                {avatar}                            </div><div class="info">                            <strong>                            {link}                            </strong>                            <ul>{info}</ul></div>                        </div>';
Chatterbox.template.loginfobox='<li class="loginfo {ref}"><a href="#{ref}" class="close iconic x"></a>{content}</li>';Chatterbox.template.whois={};Chatterbox.template.whoiswrap='<div class="whoiswrap">                                <div class="avatar">{avatar}</div>                                <div class="info">{info}</div>                                </div>';Chatterbox.template.whoisinfo="<p>{username}</p><ul>{info}</ul>{connections}";