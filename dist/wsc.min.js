var wsc={};wsc.VERSION="0.8.53";wsc.STATE="beta";wsc.defaults={};wsc.defaults.theme="wsct_default";wsc.defaults.themes=["wsct_default","wsct_dAmn"];function EventEmitter(){var j={},a=this;function g(p,q){var m=j[p]||false;if(m===false){j[p]=[q];return a}j[p].unshift(q);return a}function f(m){j[m]=[];return a}function b(){var m=Array.prototype.slice.call(arguments);var v=m.shift();var q=j[v]||false;if(q===false){return a}for(var p in q){if(q.hasOwnProperty(p)){bubble=q[p].apply({},m);if(bubble===false){break}}}return a}function l(m){return j[m]||[]}this.addListener=g;this.removeListeners=f;this.emit=b;this.listeners=l}wsc.Transport=function(g,b,f,a){this.sock=null;this.conn=null;this.server=g;this.open(b);this.message(f);this.disconnect(a)};wsc.Transport.Create=function(g,b,f,a){if(typeof io!=="undefined"){return new wsc.SocketIO(g,b,f,a)}if(!window.WebSocket){throw"This browser does not support websockets."}return new wsc.WebSocket(g,b,f,a)};wsc.Transport.prototype.open=function(a){this._open=a||this.sopen};wsc.Transport.prototype.message=function(a){this._message=a||this.smessage};wsc.Transport.prototype.disconnect=function(a){this._disconnect=a||this.sdisconnect};wsc.Transport.prototype.sopen=function(){};wsc.Transport.prototype.smessage=function(){};wsc.Transport.prototype.sdisconnect=function(){};wsc.Transport.prototype._open=function(b,a){};wsc.Transport.prototype._message=function(a){};wsc.Transport.prototype._disconnect=function(a){};wsc.Transport.prototype.connect=function(){};wsc.Transport.prototype.send=function(a){};wsc.Transport.prototype.close=function(){};wsc.WebSocket=function(g,b,f,a){this.sock=null;this.conn=null;this.server=g;this.open(b);this.message(f);this.disconnect(a)};wsc.WebSocket.prototype=new wsc.Transport;wsc.WebSocket.prototype.constructor=wsc.WebSocket;wsc.WebSocket.prototype.onopen=function(b,a){this.sock=a||this.conn;this._open(b,this)};wsc.WebSocket.prototype.ondisconnect=function(a){this.sock=null;this.conn=null;this._disconnect(a)};wsc.WebSocket.prototype.connect=function(){var a=this;this.conn=new WebSocket(this.server);this.conn.onopen=function(f,b){a.onopen(f,b)};this.conn.onmessage=this._message;this.conn.onclose=function(b){a.ondisconnect(b)}};wsc.WebSocket.prototype.send=function(a){if(this.sock==null){return -1}return this.sock.send(a)};wsc.WebSocket.prototype.close=function(){if(this.sock==null){return}this.sock.close()};wsc.SocketIO=function(g,b,f,a){this.sock=null;this.conn=null;this.server=g;this.open(b);this.message(f);this.disconnect(a)};wsc.SocketIO.prototype=new wsc.Transport("");wsc.SocketIO.prototype.constructor=wsc.SocketIO;wsc.SocketIO.prototype.connect=function(){var a=this;this.conn=io.connect(this.server);this.conn.on("connect",function(f,b){a.onopen(f,b)});this.conn.on("message",function(b){a._message({data:b})});this.conn.on("close",function(b){a.ondisconnect(b)})};wsc.SocketIO.prototype.onopen=function(b,a){this.sock=a||this.conn;this._open(b,this)};wsc.SocketIO.prototype.ondisconnect=function(a){this.sock=null;this.conn=null;this._disconnect(a)};wsc.SocketIO.prototype.send=function(a){if(this.sock==null){return -1}return this.sock.send(a)};wsc.SocketIO.prototype.close=function(){if(this.sock==null){return}this.sock.close()};Function.prototype.bind=function(b){var a=this;return function(){return a.apply(b,arguments)}};function scope_methods(b,a){for(cbn in a){b[cbn]=a[cbn].bind(b)}}Function.prototype.scope_methods=function(b,a){for(cbn in a){b[cbn]=a[cbn].bind(b)}};function bind(b,a){return a.bind(b)}function $_GET(f,b){b=b||window.location.search;var a=new RegExp("&"+f+"(?:=([^&]*))?(?=&|$)","i");b=b.replace(/^\?/,"&").match(a);if(b){return typeof b[1]!="undefined"?decodeURIComponent(b[1].replace(/\+/g,"%20")):""}}function UnixTimestamp(a){ret=new Date(a*1000);return ret}var Months=["January","February","March","April","May","June","July","August","September","October","November","December"];function PosEnd(a){return a=="1"?"st":(a=="2"?"nd":(a=="3"?"rd":"th"))}function DateStamp(a){a=UnixTimestamp(a);date=String(a.getDate());month=a.getMonth();df=date[date.length-1];return date+PosEnd(df)+" of "+Months[month]+", "+a.getFullYear()}function caseInsensitiveSort(g,f){g=g.toLowerCase();f=f.toLowerCase();return((g>f)?1:(g<f?-1:0))}function EscapeRegExp(a){return a.replace((new RegExp("(\\"+["/",".","*","+","?","|","(",")","[","]","{","}","\\"].join("|\\")+")","g")),"\\$1")}String.prototype.replacePArg=function(b,a){return replaceAll(this,b,a)};String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,f){return typeof a[f]!="undefined"?a[f]:b})};String.prototype.replaceAll=function(b,a){return replaceAllRaw(this,b,a)};replaceAllRaw=function(f,b,a){while(f.indexOf(b)>-1){f=f.replace(b,a)}return f};replaceAll=function(f,b,a){b=new RegExp(EscapeRegExp(b),"g");return f.replace(b,a||"")};Object.size=function(f){var b=0,a;for(a in f){if(f.hasOwnProperty(a)){b++}}return b};Object.steal=function(g,f){for(index in f){g[index]=f[index]}};Object.extend=function(g,f){obj={};Object.steal(obj,g);Object.steal(obj,f);return obj};function getscrollbarWidth(){if($.browser.msie){var f=$('<textarea cols="10" rows="2"></textarea>').css({position:"absolute",top:-1000,left:-1000}).appendTo("body"),b=$('<textarea cols="10" rows="2" style="overflow: hidden;"></textarea>').css({position:"absolute",top:-1000,left:-1000}).appendTo("body");scrollbarWidth=f.width()-b.width();f.add(b).remove()}else{var a=$("<div />").css({width:100,height:100,overflow:"auto",position:"absolute",top:-1000,left:-1000}).prependTo("body").append("<div />").find("div").css({width:"100%",height:200});scrollbarWidth=100-a.width();a.parent().remove()}return scrollbarWidth}var chains=[["recv","admin"]];wsc.Packet=function(b,g){if(!(b)){return null}var a={cmd:null,param:null,arg:{},body:null,sub:[],raw:b};g=g||"=";try{idx=b.indexOf("\n\n");if(idx>-1){a.body=b.substr(idx+2);b=b.substr(0,idx)}args=b.split("\n");if(args[0].indexOf(g)==-1){cline=args.shift().split(" ");a.cmd=cline.shift()||null;if(cline.length>0){a.param=cline.join(" ")}}for(n in args){arg=args[n];si=arg.search(g);if(si==-1){continue}a.arg[arg.substr(0,si)]=arg.substr(si+g.length)||""}if(a.body!=null){subs=a.body.split("\n\n");for(i in subs){sub=wsc.Packet(subs[i],g);if(sub==null){break}a.sub.push(sub)}}}catch(f){return null}a.toString=function(){return packetToString(a)};a.name=packetEvtName(a);return a};function wsc_packetstr(j,l,f,a){var b="";if(j){b=j;if(l){b=b+" "+l}}if(f){for(var g in f){b=b+"\n"+g+"="+f[g]}}b=b+"\n";if(a){b=b+"\n"+a}return b}function packetToString(a){return wsc_packetstr(a.cmd,a.param,a.arg,a.body)}function packetEvtName(b){var g=b.cmd;var a=null;for(var f in chains){a=chains[f];if(a[0]!=g){continue}var j=b.sub[0];g=g+"_"+j.cmd;if(a.length>1&&j.param!=undefined){if(a[1]==j.cmd){return g+"_"+j.param}}}return g}wsc.Channel=function(a,b,f){this.info={members:{},pc:{},pc_order:[],title:{content:"",by:"",ts:""},topic:{content:"",by:"",ts:""},};this.client=a;this.hidden=f;this.ui=null;this.raw=a.format_ns(b);this.selector=a.deform_ns(b).slice(1).toLowerCase();this.namespace=a.deform_ns(b);this.monitor=Object.size(this.client.channelo)==0};wsc.Channel.prototype.build=function(){this.info.members={};this.client.ui.create_channel(this.namespace,this.hidden);this.ui=this.client.ui.channel(ns)};wsc.Channel.prototype.remove=function(){if(this.ui==null){return}this.ui.remove()};wsc.Channel.prototype.hide=function(){if(this.ui==null){return}this.ui.hide()};wsc.Channel.prototype.show=function(){if(this.ui==null){return}this.ui.show()};wsc.Channel.prototype.log=function(a){if(this.ui==null){return}this.ui.log(a)};wsc.Channel.prototype.logItem=function(a){if(this.ui==null){return}this.ui.log_item(a)};wsc.Channel.prototype.server_message=function(b,a){if(this.ui==null){return}this.ui.server_message(b,a)};wsc.Channel.prototype.property=function(a){var b=a.pkt.arg["p"];switch(b){case"title":case"topic":this.set_header(b,a);break;case"privclasses":this.set_privclasses(a);break;case"members":this.set_members(a);break;default:this.server_message("Received unknown property "+b+" received in "+this.info.namespace+".");break}};wsc.Channel.prototype.set_header=function(a,b){this.info[a]["content"]=b.value||"";this.info[a]["by"]=b.by;this.info[a]["ts"]=b.ts;if(this.ui==null){return}this.ui.set_header(a,b.value.html()||"")};wsc.Channel.prototype.set_privclasses=function(f){this.info.pc={};this.info.pc_order=[];var a=f.pkt.body.split("\n");for(var b in a){if(!a[b]){continue}bits=a[b].split(":");this.info.pc_order.push(parseInt(bits[0]));this.info.pc[parseInt(bits[0])]=bits[1]}this.info.pc_order.sort(function(j,g){return g-j})};wsc.Channel.prototype.set_members=function(a){pack=new wsc.Packet(a.pkt.body);this.info.members={};this.info.users=[];while(pack.cmd=="member"){this.register_user(pack);pack=new wsc.Packet(pack.body);if(pack==null){break}}this.set_user_list()};wsc.Channel.prototype.set_user_list=function(){if(Object.size(this.info.members)==0){return}pcs={};this.info.users.sort(caseInsensitiveSort);for(i in this.info.users){un=this.info.users[i];member=this.info.members[un];if(!(member.pc in pcs)){pcs[member.pc]={name:member.pc,users:[]}}conn=member.conn==1?"":"["+member.conn+"]";s=member.symbol;uinfo={name:un,symbol:s,conn:member.conn,hover:{member:member,name:un,avatar:'<img class="avatar" src="" height="50" width="50" />',link:s+'<a target="_blank" href="http://'+un+"."+this.client.settings.domain+'/">'+un+"</a>",info:[]}};pcs[member.pc].users.push(uinfo)}ulist=[];for(var a in this.info.pc_order){pc=this.info.pc[this.info.pc_order[a]];if(!(pc in pcs)){continue}ulist.push(pcs[pc])}if(this.ui!=null){this.ui.set_user_list(ulist)}this.client.trigger("set.userlist",{name:"set.userlist",ns:this.info.namespace})};wsc.Channel.prototype.register_user=function(a){un=a.param;if(this.info.members[un]==undefined){this.info.members[un]=a.arg;this.info.members[un]["username"]=un;this.info.members[un]["conn"]=1}else{for(i in a.arg){this.info.members[un][i]=a.arg[i]}this.info.members[un]["conn"]++}if(this.info.users.indexOf(un)==-1){this.info.users.push(un)}};wsc.Channel.prototype.remove_user=function(a,b){b=b||false;member=this.info.members[a];if(member==undefined){return}member.conn--;if(member.conn>0&&!b){return}this.info.users.splice(this.info.users.indexOf(a),1);delete this.info.members[a]};wsc.Channel.prototype.recv_join=function(a){info=new wsc.Packet("user "+a.user+"\n"+a.info);this.register_user(info);this.set_user_list()};wsc.Channel.prototype.recv_part=function(a){this.remove_user(a.user);this.set_user_list()};wsc.Channel.prototype.recv_msg=function(a){u=this.client.settings.username.toLowerCase();msg=a.message.toLowerCase();if(msg.indexOf(u)<0){return}if(this.ui!=null){this.ui.highlight()}};wsc.Channel.prototype.recv_privchg=function(a){member=this.info.members[a.user];if(!member){return}member.pc=event.pc;this.set_user_list()};wsc.Channel.prototype.recv_kicked=function(a){this.remove_user(a.user,true);this.set_user_list()};wsc.TablumpString=function(a,b){this._parser=b||new wsc.Tablumps();this.raw=a;this._text=null;this._html=null;this._ansi=null};with(wsc.TablumpString.prototype=new String){constructor=wsc.TablumpString;toString=valueOf=function(){return this.raw}}wsc.TablumpString.prototype.html=function(){if(this._html==null){this._html=this._parser.render(1,this.raw)}return this._html};wsc.TablumpString.prototype.text=function(){if(this._text==null){this._text=this._parser.render(0,this.raw)}return this._text};wsc.TablumpString.prototype.ansi=function(){if(this._ansi==null){this._ansi=this._parser.render(2,this.raw)}return this._ansi};wsc.Tablumps=function(){this.lumps=this.defaultMap();this._list=[];this._dent=0};wsc.Tablumps.prototype.registerMap=function(a){this.lumps=a};wsc.Tablumps.prototype.extend=function(a){for(index in a){this.lumps[index]=a[index]}};wsc.Tablumps.prototype._list_start=function(a){list={};list.ol=a||false;list.count=0;ret=this._list[0]?"":"\n";this._dent++;this._list.unshift(list);return ret};wsc.Tablumps.prototype._list_end=function(){if(this._list.length==0){return""}list=this._list.shift();this._dent--;return(this._dent==0&&list.count==0)?"\n":""};wsc.Tablumps.prototype.defaultMap=function(){return{"&b\t":[0,"","<b>","\x1b[1m"],"&/b\t":[0,"","</b>","\x1b[22m"],"&i\t":[0,"","<i>","\x1b[3m"],"&/i\t":[0,"","</i>","\x1b[23m"],"&u\t":[0,"","<u>","\x1b[4m"],"&/u\t":[0,"","</u>","\x1b[24m"],"&s\t":[0,"","<s>","\x1b[9m"],"&/s\t":[0,"","</s>","\x1b[29m"],"&sup\t":[0,"/","<sup>"],"&/sup\t":[0,"/","</sup>"],"&sub\t":[0,"\\","<sub>"],"&/sub\t":[0,"\\","</sub>"],"&code\t":[0,"``","<code>"],"&/code\t":[0,"``","</code>"],"&p\t":[0,"\n","<p>"],"&/p\t":[0,"\n","</p>"],"&ul\t":[0,function(a){return this._list_start()},"<ul>"],"&/ul\t":[0,function(a){return this._list_end()},"</ul>"],"&ol\t":[0,function(a){return this._list_start(true)},"<ol>"],"&li\t":[0,function(b){list=this._list[0]||{count:0,ol:false};list.count++;buf="\n";for(var a=0;a<this._dent;a++){buf=buf+"  "}if(list.ol){buf=buf+String(list.count)+"."}else{buf=buf+"*"}return buf+" "},"<li>"],"&/li\t":[0,"\n","</li>"],"&/ol\t":[0,function(a){return this._list_end(true)},"</ol>"],"&link\t":[3,function(a){return"[link:"+a[0]+"]"+(a[1]||"")+"[/link]"},function(a){t=a[1];return'<a target="_blank" href="'+a[0]+'" title="'+(t||a[0])+'">'+(t||"[link]")+"</a>"}],"&acro\t":[1,"[acro:{0}]",'<acronym title="{0}">'],"&/acro\t":[0,"[/acro]","</acronym>"],"&abbr\t":[1,"[abbr:{0}]",'<abbr title="{0}">'],"&/abbr\t":[0,"[/abbr]","</abbr>"],"&img\t":[3,"`{2}`({0})",'<img src="{0}" alt="{1}" title="{2}" />'],"&iframe\t":[3,"[iframe:{0}]",'<iframe src="{0}" width="{1}" height="{2}" />'],"&/iframe\t":[0,"","</iframe>"],"&a\t":[2,"[link:{0}]",'<a target="_blank" href="{0}" title="{1}">'],"&/a\t":[0,"[/link]","</a>"],"&br\t":[0,"\n","<br/>"],"&bcode\t":[0,"\n","<span><pre><code>"],"&/bcode\t":[0,"\n","</code></pre></span>"],EOF:[0,"",null,"\x1b[m"]}};wsc.Tablumps.prototype.parse=function(b,a){return new wsc.TablumpString(b,this)};wsc.Tablumps.prototype.render=function(a,f){if(!f){return""}sep="\t";a=a+1;for(var b=0;b<f.length;b++){if(f[b]!="&"){continue}primer=f.substring(0,b);working=f.substring(b);ti=working.indexOf("\t");if(ti==-1){continue}tag=working.substring(0,ti+1);working=working.substring(ti+1);rendered=this.renderOne(a,tag,working);if(rendered===null){b++;continue}f=primer+rendered[0];b=b+(rendered[1]-1)}return f+this.renderOne(a,"EOF","")[0]};wsc.Tablumps.prototype.renderOne=function(f,b,a){lump=this.lumps[b];if(lump===undefined){return null}if(lump[0]==0){cropping=[[],a]}else{cropping=this.tokens(a,lump[0],sep)}renderer=lump[f]||lump[1];if(typeof(renderer)=="string"){parsed=renderer.format.apply(renderer,cropping[0])}else{parsed=renderer.call(this,cropping[0])}return[parsed+cropping[1],parsed.length]};wsc.Tablumps.prototype.tokens=function(g,b,f,a){f=f||"\t";a=a||"&";tokens=[];for(i=b;i>0;i--){find=g.indexOf(f);if(find==-1){break}tokens.push(g.substring(0,find));g=g.substring(find+1);if(tokens[tokens.length-1]==a){tokens.pop();break}}return[tokens,g]};wsc.Protocol=function(a){this.tablumps=a||new wsc.Tablumps;this.chains=[["recv","admin"]];this.maps={chatserver:["version"],login:["username",["e"],"data"],join:["ns",["e"]],part:["ns",["e","*r"]],property:["ns",["p","by","ts"],"*value"],recv_msg:[null,[["from","user"]],"*message"],recv_npmsg:[null,[["from","user"]],"message"],recv_action:[null,["s",["from","user"]],"*message"],recv_join:["user",["s"],"*info"],recv_part:["user",["s","r"]],recv_privchg:["user",["s","by","pc"]],recv_kicked:["user",[["i","s"],"by"],"*r"],recv_admin_create:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_update:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_rename:[null,["p",["by","user"],"prev",["name","pc"]]],recv_admin_move:[null,["p",["by","user"],"prev",["name","pc"],["n","affected"]]],recv_admin_remove:[null,["p",["by","user"],["name","pc"],["n","affected"]]],recv_admin_show:[null,["p"],"info"],recv_admin_showverbose:[null,["p"],"info"],recv_admin_privclass:[null,["p","e"],"command"],kicked:["ns",[["by","user"]],"*r"],ping:[],disconnect:[null,["e"]],send:["ns",["e"]],kick:["ns",[["u","user"],"e"]],get:["ns",["p","e"]],set:["ns",["p","e"]],kill:["ns",["e"]],unknown:[null,null,null,"packet"],};var b=this;this.mapper={recv:function(j,g,f){g.ns=j.param;sub=new wsc.Packet(j.body);if(sub.cmd=="admin"){ssub=new wsc.Packet(sub.body);return b.map(ssub,g,f)}return b.map(sub,g,f)}};this.messages={chatserver:['<span class="servermsg">** Connected to llama {version} *</span>',false,true],login:['<span class="servermsg">** Login as {username}: "{e}" *</span>',false,true],join:['<span class="servermsg">** Join {ns}: "{e}" *</span>',true],part:['<span class="servermsg">** Part {ns}: "{e}" * <em>{*r}</em></span>',true],property:['<span class="servermsg">** Got {p} for {ns} *</span>',true],recv_msg:['<span class="cmsg user u-{user}"><strong>&lt;{user}&gt;</strong></span><span class="cmsg u-{user}">{message}</span>'],recv_npmsg:['<span class="cmsg user u-{user}"><strong>&lt;{user}&gt;</strong></span><span class="cmsg u-{user}">{message}</span>'],recv_action:['<span class="caction user u-{user}"><em>* {user}</em></span><span class="caction u-{user}">{message}</span>'],recv_join:['<span class="cevent bg">** {user} has joined *</span>'],recv_part:['<span class="cevent bg">** {user} has left * <em>{r}</em></span>'],recv_privchg:['<span class="cevent">** {user} has been made a member of {pc} by {by} *</span>'],recv_kicked:['<span class="cevent">** {user} has been kicked by {by} * <em>{*r}</em></span>'],recv_admin_create:['<span class="cevent admin">** Privilege class {pc} has been created by {user} with: {privs} *</span>'],recv_admin_update:['<span class="cevent admin">** Privilege class {pc} has been updated by {user} with: {privs} *</span>'],recv_admin_rename:['<span class="cevent admin">** Privilege class {prev} has been renamed to {name} by {user} *</span>'],recv_admin_move:['<span class="cevent admin">** All members of {prev} have been moved to {pc} by {user} -- {affected} affected user(s) *</span>'],recv_admin_remove:['<span class="cevent admin">** Privilege class {pc} has been removed by {user} -- {affected} affected user(s) *</span>'],recv_admin_show:null,recv_admin_showverbose:null,recv_admin_privclass:['<span class="cevent admin">** Admin command "{command}" failed: {e} *</span>'],kicked:['<span class="servermsg">** You have been kicked by {user} * <em>{r}</em></span>'],ping:null,disconnect:['<span class="servermsg">** You have been disconnected * <em>{e}</em></span>',false,true],send:['<span class="servermsg">** Send error: <em>{e}</em></span>'],kick:['<span class="servermsg">** Could not kick {user}: <em>{e}</em></span>'],get:['<span class="servermsg">** Could not get {p} info for {ns}: <em>{e}</em></span>'],set:['<span class="servermsg">** Could not set {p}: <em>{e}</em></span>'],kill:['<span class="servermsg">** Kill error: <em>{e}</em></span>'],unknown:['<span class="servermsg">** Received unknown packet in {ns}: <em>{packet}</em></span>',true],}};wsc.Protocol.prototype.extend_maps=function(a){for(key in a){this.maps[key]=a[key]}};wsc.Protocol.prototype.extend_messages=function(a){for(key in a){this.messages[key]=a[key]}};wsc.Protocol.prototype.parse=function(b){name=this.event(b);if(!(name in this.maps)){console.log("unknown: ",name);console.log(this.maps);mapping=this.maps.unknown;name="unknown"}else{mapping=this.maps[name]}var a={name:name,pkt:b,ns:null};cmd=b.cmd;if(this.mapper[cmd]){this.mapper[cmd](b,a,mapping)}else{this.map(b,a,mapping)}return a};wsc.Protocol.prototype.event=function(b){var g=b.cmd;var a=null;for(var f in this.chains){a=this.chains[f];if(a[0]!=g){continue}var j=b.sub[0];g=g+"_"+j.cmd;if(a.length>1&&j.param!=undefined){if(a[1]==j.cmd){return g+"_"+j.param}}}return g};wsc.Protocol.prototype.map=function(g,b,f){for(var a in mapping){if(mapping[a]==null){continue}key=mapping[a];skey=key;switch(parseInt(a)){case 0:b[key]=g.param;break;case 1:if(mapping[1] instanceof Array){for(n in mapping[1]){key=mapping[1][n];if(key instanceof Array){b[key[1]]=g.arg[key[0]];skey=key[1]}else{k=key[0]=="*"?key.slice(1):key;b[key]=g.arg[k]||"";skey=key}}}if(typeof mapping[1]=="string"){b[key]=g.arg.slice(0)}break;case 2:if(key instanceof Array){this.mapPacket(b,new wsc.Packet(g.body),key)}else{b[key]=g.body}break;case 3:b[key]=g.raw;break}if(skey[0]!="*"){continue}k=skey.slice(1);val=this.tablumps.parse(b[skey]);b[k]=val}};wsc.Protocol.prototype.render=function(a,b){msgm=this.messages[a.name];if(!msgm){return""}msg=msgm[0];for(key in a){d=a[key];if(key=="ns"||key=="sns"){key="ns";d=a.sns}if(d.hasOwnProperty("_parser")){switch(b){case"text":d=d.text();break;case"html":d=d.html();break;case"ansi":d=d.ansi();break;default:d=d.text();break}}msg=replaceAll(msg,"{"+key+"}",d)}return msg};wsc.Protocol.prototype.log=function(a,b){msgm=this.messages[b.name];if(!msgm){return}if(b.s=="0"){return}msg=this.render(b,"html");if(!msgm[2]){if(!msgm[1]){a.ui.channel(b.ns).log_item(msg)}else{a.ui.channel(a.mns).log_item(msg)}}else{a.ui.log_item(msg)}};wsc.Flow=function(a){this.protocol=a||new wsc.Protocol()};wsc.Flow.prototype.open=function(a,f,b){a.trigger("connected",{name:"connected",pkt:new wsc.Packet("connected\n\n")});a.connected=true;a.handshake();a.attempts=0};wsc.Flow.prototype.close=function(a,b){a.trigger("closed",{name:"closed",pkt:new wsc.Packet("connection closed\n\n")});console.log(b);if(a.connected){a.ui.server_message("Connection closed");a.connected=false}else{a.ui.server_message("Connection failed")}if(a.attempts>2){a.ui.server_message("Can't connect. Try again later.");a.attempts=0;return}a.ui.server_message("Connecting in 2 seconds");setTimeout(function(){a.conn.connect()},2000)};wsc.Flow.prototype.message=function(a,g){var b=new wsc.Packet(g.data);if(b==null){return}var f=this.protocol.parse(b);if(f.ns==null){f.ns=a.mns}f.sns=a.deform_ns(f.ns);this.protocol.log(a,f);this.handle(a,f);a.trigger("pkt",f);a.trigger("pkt."+f.name,f)};wsc.Flow.prototype.handle=function(a,f){try{this[f.name](f,a)}catch(b){}};wsc.Flow.prototype.ping=function(b,a){a.pong()};wsc.Flow.prototype.chatserver=function(b,a){a.login()};wsc.Flow.prototype.login=function(b,a){if(b.pkt.arg["e"]=="ok"){info=new wsc.Packet("info\n"+b.data);a.settings.username=b.pkt.param;a.settings.symbol=info.arg.symbol;a.settings.userinfo=info.arg;if(a.fresh){a.join(a.settings.autojoin)}else{for(key in a.channelo){if(a.channelo[key].namespace[0]!="~"){a.join(key)}}}}else{}if(a.fresh){a.fresh=false}};wsc.Flow.prototype.join=function(b,a){if(b.pkt.arg["e"]=="ok"){ns=a.deform_ns(b.pkt.param);a.create_ns(ns);a.ui.channel(ns).server_message("You have joined "+ns)}else{a.ui.chatbook.current.server_message("Failed to join "+a.deform_ns(b.pkt.param),b.pkt.arg["e"])}};wsc.Flow.prototype.part=function(b,a){ns=a.deform_ns(b.ns);c=a.channel(ns);if(b.e=="ok"){info="";if(b.r.length>0){info="["+b.r+"]"}else{a.remove_ns(ns)}msg="You have left "+ns;c.server_message(msg,info);if(a.channels()==0){switch(b.r){case"bad data":case"bad msg":case"msg too big":break;default:if(b.r.indexOf("killed:")<0){return}break}this.process_data({data:"disconnect\ne="+e.r+"\n"})}}else{a.monitor("Couldn't leave "+ns,b.e);c.server_message("Couldn't leave "+ns,b.e)}};wsc.Flow.prototype.kicked=function(b,a){if(b.r.toLowerCase().indexOf("autokicked")>-1){return}a.join(b.ns)};wsc.Flow.prototype.property=function(b,a){chan=a.channel(b.pkt.param);if(!chan){return}chan.property(b)};wsc.Flow.prototype.recv_joinpart=function(b,a){c=a.channel(b.ns);if(b.name=="recv_join"){c.recv_join(b)}else{c.recv_part(b)}};wsc.Flow.prototype.recv_join=wsc.Flow.prototype.recv_joinpart;wsc.Flow.prototype.recv_part=wsc.Flow.prototype.recv_joinpart;wsc.Flow.prototype.recv_msg=function(b,a){a.channel(b.ns).recv_msg(b)};wsc.Flow.prototype.recv_action=wsc.Flow.prototype.recv_msg;wsc.Flow.prototype.recv_npmsg=wsc.Flow.prototype.recv_msg;wsc.Flow.prototype.recv_privchg=function(b,a){a.channel(b.ns).recv_privchg(b)};wsc.Flow.prototype.recv_kicked=function(b,a){a.channel(b.ns).recv_kicked(b)};wsc.defaults.Extension=function(a){var b={init:function(f){this.client=f;this.client.bind("cmd.set",this.setter.bind(b));this.client.bind("cmd.connect",this.connect.bind(b));this.client.bind("cmd.join",this.join.bind(b));this.client.bind("cmd.part",this.part.bind(b));this.client.bind("cmd.title",this.title.bind(b));this.client.bind("cmd.promote",this.promote.bind(b));this.client.bind("cmd.me",this.action.bind(b));this.client.bind("cmd.kick",this.kick.bind(b));this.client.bind("cmd.raw",this.raw.bind(b));this.client.bind("cmd.say",this.say.bind(b));this.client.bind("cmd.npmsg",this.npmsg.bind(b));this.client.bind("cmd.clear",this.clear.bind(b));this.client.bind("cmd.theme",this.theme.bind(b));this.client.ui.on("settings.open",this.settings_page.bind(b))},settings_page:function(g,f){page=g.settings.page("Main");page.item("text",{text:"This will eventually have a whole thing of settings to use. Honest!"});console.log(page,page.render())},theme:function(g,f){theme=f.settings.theme;select=g.args.split(" ").shift();f.ui.theme(select)},setter:function(f){data=f.args.split(" ");setting=data.shift().toLowerCase();data=data.join(" ");if(data.length==0){this.client.cchannel.serverMessage("Could not set "+setting,"No data supplied");return}if(!(setting in this.client.settings)){this.client.cchannel.serverMessage('Unknown setting "'+setting+'"');return}this.client.settings[setting]=data;this.client.cchannel.serverMessage("Changed "+setting+" setting","value: "+data);this.client.control.setLabel()},connect:function(f){this.client.connect()},join:function(f){chans=f.args.split(" ");chans=chans.toString()==""?[]:chans;if(f.ns!=f.target){chans.unshift(f.target)}if(chans.toString()==""){return}for(index in chans){b.client.join(chans[index])}},part:function(f){chans=f.args.split(" ");if(f.ns!=f.target){chans.unshift(f.target)}if(chans.toString()==""){b.client.part(f.ns);return}for(index in chans){b.client.part(chans[index])}},title:function(f){b.client.set(f.target,"title",f.args)},promote:function(f){bits=f.args.split(" ");b.client.promote(f.target,bits[0],bits[1])},action:function(f){b.client.action(f.target,f.args)},raw:function(f){b.client.send(f.args.replace(/\\n/gm,"\n"))},kick:function(f){d=f.args.split(" ");u=d.shift();r=d.length>0?d.join(" "):null;b.client.kick(f.target,u,r)},say:function(f){b.client.say(f.target,f.args)},npmsg:function(f){b.client.npmsg(f.target,f.args)},clear:function(f){this.client.cchannel.logpanel.find("p.logmsg").remove();this.client.cchannel.resize()},};b.init(a);return b};wsc.Client=function(a,f,g){this.mozilla=g;this.fresh=true;this.attempts=0;this.protocol=null;this.flow=null;this.ui=null;this.events=new EventEmitter();this.conn=null;this.channelo={};this.cchannel=null;this.cmds=[];this.settings={domain:"website.com",server:"ws://website.com/wsendpoint",symbol:"",username:"",userinfo:{},pk:"",monitor:["~Monitor",true],welcome:"Welcome to the wsc web client!",autojoin:"chat:channel",control:wsc.Control,protocol:wsc.Protocol,tablumps:wsc.Tablumps,flow:wsc.Flow,ui:Chatterbox.UI,extend:[wsc.defaults.Extension],client:"chatclient",clientver:"0.3",theme:wsc.defaults.theme,themes:wsc.defaults.themes,};a.extend(this.settings,f);this.ui=new this.settings.ui(a,{themes:this.settings.themes,theme:this.settings.theme,monitor:this.settings.monitor,username:this.settings.username,domain:this.settings.domain},g);this.settings.agent=this.ui.LIB+"/"+this.ui.VERSION+" ("+navigator.appVersion.match(/\(([^)]+)\)/)[1]+") wsc/"+wsc.VERSION;this.mns=this.format_ns(this.settings.monitor[0]);this.lun=this.settings.username.toLowerCase();this.protocol=new this.settings.protocol(new this.settings.tablumps());this.flow=new this.settings.flow(this.protocol);this.build();for(var b in this.settings.extend){this.settings.extend[b](this)}this.monitor(this.settings.welcome)};wsc.Client.prototype.build=function(){this.ui.build();this.control=new this.settings.control(this);var a=this;this.ui.on("channel.selected",function(b,f){a.cchannel=a.channel(b.ns);a.control.cache_input(b)});this.ui.on("tab.close.clicked",function(b,f){if(b.chan.monitor){return}a.part(b.ns)})};wsc.Client.prototype.loop=function(){for(key in this.channelo){c=this.channelo[key];msgs=c.ui.logpanel.find(".logmsg");if(msgs.length<200){continue}msgs.slice(0,msgs.length-200).remove();c.ui.resize()}};wsc.Client.prototype.add_extension=function(a){this.settings.extend.push(a);a(this)};wsc.Client.prototype.bind=function(b,a){this.events.addListener(b,a);if(b.indexOf("cmd.")!=0||b.length<=4){return}cmd=b.slice(4).toLowerCase();this.cmds.push(cmd)};wsc.Client.prototype.clear_listeners=function(a){this.events.removeListeners(a)};wsc.Client.prototype.trigger=function(a,b){this.events.emit(a,b,this)};wsc.Client.prototype.connect=function(){if(this.connected){return}this.attempts++;try{var a=this;this.conn=wsc.Transport.Create(this.settings.server);this.conn.open(function(f,g){a.flow.open(a,f,g)});this.conn.disconnect(function(f){a.flow.close(a,f)});this.conn.message(function(f){a.flow.message(a,f)});this.conn.connect();this.ui.server_message("Opening connection");this.trigger("start",new wsc.Packet("client connecting\ne=ok\n\n"))}catch(b){console.log(b);this.monitor("Your browser does not support WebSockets. Sorry.");this.trigger("start",new wsc.Packet("client connecting\ne=no websockets available\n\n"))}};wsc.Client.prototype.close=function(){this.conn.close()};wsc.Client.prototype.channel=function(a,b){a=this.deform_ns(a).slice(1).toLowerCase();if(!this.channelo[a]&&b){this.channelo[a]=b}return this.channelo[a]};wsc.Client.prototype.channels=function(){chans=-1;for(ns in this.channelo){if(this.channelo[ns].hidden){continue}chans++}return chans};wsc.Client.prototype.deform_ns=function(a){if(a.indexOf("chat:")==0){return"#"+a.slice(5)}if(a.indexOf("server:")==0){return"~"+a.slice(7)}if(a.indexOf("pchat:")==0){var b=a.split(":");b.shift();for(i in b){name=b[i];if(name.toLowerCase()!=this.lun){return"@"+name}}}if(a.indexOf("login:")==0){return"@"+a.slice(6)}if(a[0]!="#"&&a[0]!="@"&&a[0]!="~"){return"#"+a}return a};wsc.Client.prototype.format_ns=function(a){if(a.indexOf("#")==0){return"chat:"+a.slice(1)}if(a.indexOf("@")==0){var b=[a.slice(1),this.lun];b.sort(caseInsensitiveSort);b.unshift("pchat");return b.join(":")}if(a.indexOf("~")==0){return"server:"+a.slice(1)}if(a.indexOf("chat:")!=0&&a.indexOf("server:")!=0&&a.indexOf("pchat:")!=0){return"chat:"+a}return a};wsc.Client.prototype.create_ns=function(a,b){chan=this.channel(a,new wsc.Channel(this,a,b));chan.build()};wsc.Client.prototype.remove_ns=function(a){this.ui.remove_channel(a)};wsc.Client.prototype.log=function(a,b){var f=this.channel(a);if(!f){return}f.log(b)};wsc.Client.prototype.monitor=function(a){this.ui.monitor(a)};wsc.Client.prototype.send=function(a){return this.conn.send(a)};wsc.Client.prototype.handshake=function(){this.send(wsc_packetstr(this.settings.client,this.settings.clientver,{agent:this.settings.agent}))};wsc.Client.prototype.login=function(){pkt="login "+this.settings.username+"\npk="+this.settings.pk+"\n";this.send(pkt)};wsc.Client.prototype.pong=function(){this.send(wsc_packetstr("pong"))};wsc.Client.prototype.join=function(a){this.send(wsc_packetstr("join",this.format_ns(a)))};wsc.Client.prototype.part=function(a){this.send(wsc_packetstr("part",this.format_ns(a)))};wsc.Client.prototype.say=function(a,b){e={name:"send.msg.before",msg:b,ns:a};this.trigger(e);this.send(wsc_packetstr("send",this.format_ns(a),{},wsc_packetstr("msg","main",{},e.msg)))};wsc.Client.prototype.npmsg=function(a,b){e={name:"send.npmsg.before",msg:b,ns:a};this.trigger(e);this.send(wsc_packetstr("send",this.format_ns(a),{},wsc_packetstr("npmsg","main",{},e.msg)))};wsc.Client.prototype.action=function(a,b){e={name:"send.action.before",msg:b,ns:a};this.trigger(e);this.send(wsc_packetstr("send",this.format_ns(a),{},wsc_packetstr("action","main",{},e.msg)))};wsc.Client.prototype.promote=function(f,a,b){this.send(wsc_packetstr("send",this.format_ns(f),{},wsc_packetstr("promote",a,{},(!b?"":b))))};wsc.Client.prototype.demote=function(f,a,b){this.send(wsc_packetstr("send",this.format_ns(f),{},wsc_packetstr("demote",a,{},(!b?"":b))))};wsc.Client.prototype.ban=function(b,a){this.send(wsc_packetstr("send",this.format_ns(b),{},wsc_packetstr("ban",a,{},(!pc?"":pc))))};wsc.Client.prototype.unban=function(b,a){this.send(wsc_packetstr("send",this.format_ns(namespace),{},wsc_packetstr("unban",a,{},(!pc?"":pc))))};wsc.Client.prototype.kick=function(b,a,f){this.send(wsc_packetstr("kick",this.format_ns(b),{u:a},f||null))};wsc.Client.prototype.kill=function(a,b){this.send(wsc_packetstr("kill",a,{},b||null))};wsc.Client.prototype.admin=function(a,b){this.send(wsc_packetstr("send",this.format_ns(a),{},wsc_packetstr("admin","",{},b)))};wsc.Client.prototype.property=function(a,b){this.send(wsc_packetstr("get",this.format_ns(a),{p:b}))};wsc.Client.prototype.set=function(a,b){this.send(wsc_packetstr("set",this.format_ns(a),{p:b},value))};wsc.Client.prototype.whois=function(a){this.send(wsc_packetstr("get","login:"+a,{p:property}))};wsc.Client.prototype.disconnect=function(){this.send(wsc_packetstr("disconnect"))};wsc.Control=function(a){this.client=a;this.ui=this.client.ui.control;this.history={};this.tab={hit:false,cache:"",matched:[],index:-1,type:0,prefix:["","/",""],};this.set_input()};wsc.Control.prototype.focus=function(){this.ui.focus()};wsc.Control.prototype.set_input=function(){var a=this;this.ui.set_handlers(function(b){return a.keypress(b)},function(b){return a.submit(b)})};wsc.Control.prototype.cache_input=function(a){h=this.get_history(a.prev.namespace);if(h.index>-1){return}h.tmp=this.ui.get_text();this.ui.set_text(this.get_history(a.chan.namespace).tmp)};wsc.Control.prototype.get_history=function(a){a=a||this.client.cchannel.namespace;if(!this.history[a]){this.history[a]={index:-1,list:[],tmp:""}}return this.history[a]};wsc.Control.prototype.append_history=function(a){if(!a){return}h=this.get_history();h.list.unshift(a);h.index=-1;if(h.list.length>100){h.list.pop()}};wsc.Control.prototype.scroll_history=function(a){history=this.get_history();data=this.ui.get_text();if(history.index==-1){if(data){history.tmp=data}else{history.list[history.index]=data}}if(a){if(history.list.length>0&&history.index<(history.list.length-1)){history.index++}}else{if(history.index>-1){history.index--}}this.ui.set_text(history.list[history.index]||history.tmp)};wsc.Control.prototype.tab_item=function(a){if(!this.tab.hit){this.start_tab(a)}this.ui.chomp();this.tab.index++;if(this.tab.index>=this.tab.matched.length){this.tab.index=-1}if(this.tab.index==-1){this.ui.unchomp(this.tab.prefix[this.tab.type]+this.tab.cache);return}suf=this.ui.get_text()==""?(this.tab.type==0?": ":" "):"";this.ui.unchomp(this.tab.prefix[this.tab.type]+this.tab.matched[this.tab.index]+suf)};wsc.Control.prototype.start_tab=function(a){this.tab.hit=true;this.tab.index=-1;this.tab.matched=[];this.tab.type=0;needle=this.ui.chomp();this.ui.unchomp(needle);if(needle[0]=="/"||needle[0]=="#"){this.tab.type=needle[0]=="/"?1:2;needle=needle.slice(1)}else{this.tab.type=0}this.tab.cache=needle;needle=needle.toLowerCase();this.tab.matched=[];if(this.tab.type==0){for(user in this.client.cchannel.info.members){if(user.toLowerCase().indexOf(needle)==0){this.tab.matched.push(user)}}}else{if(this.tab.type==1){for(i in this.client.cmds){cmd=this.client.cmds[i];if(cmd.indexOf(needle)==0){this.tab.matched.push(cmd)}}}else{if(this.tab.type==2){for(chan in this.client.channelo){if(chan.toLowerCase().indexOf(needle)==0){this.tab.matched.push(this.client.channel(chan).namespace)}}}}}};wsc.Control.prototype.end_tab=function(a){this.tab.hit=false;this.tab.matched=[];this.tab.cache="";this.tab.index=-1};wsc.Control.prototype.submit=function(a){msg=this.ui.get_text();this.append_history(msg);this.ui.set_text("");this.handle(a,msg);return false};wsc.Control.prototype.keypress=function(b){key=b.which||b.keypress;ut=this.tab.hit;var a=false;switch(key){case 13:this.submit(b);break;case 38:this.scroll_history(true);break;case 40:this.scroll_history(false);break;case 9:this.tab_item(b);ut=false;break;default:a=true;break}if(ut){this.end_tab(b)}return a};wsc.Control.prototype.handle=function(a,b){if(b==""){return}if(b[0]!="/"){if(!this.client.cchannel){return}}b=(a.shiftKey?"/npmsg ":(b[0]=="/"?"":"/say "))+b;b=b.slice(1);bits=b.split(" ");cmdn=bits.shift();ens=this.client.cchannel.namespace;etarget=ens;if(bits[0]){hash=bits[0][0];if((hash=="#"||hash=="@")&&bits[0].length>1){etarget=this.client.format_ns(bits.shift())}}arg=bits.join(" ");this.client.trigger("cmd."+cmdn,{name:"cmd",cmd:cmdn,args:arg,target:etarget,ns:ens})};var Chatterbox={};Chatterbox.VERSION="0.4.7";Chatterbox.STATE="beta";Chatterbox.UI=function(a,b,g,f){this.events=f||new EventEmitter();this.mozilla=g;this.settings={themes:["wsct_default","wsct_dAmn"],theme:"wsct_default",monitor:["~Monitor",true],username:"",domain:"website.com"};a.extend(this.settings,b);a.append('<div class="wsc '+this.settings.theme+'"></div>');this.view=a.find(".wsc");this.mns=this.format_ns(this.settings.monitor[0]);this.lun=this.settings.username.toLowerCase();this.monitoro=null;this.swidth=getscrollbarWidth();this.LIB="Chatterbox";this.VERSION=Chatterbox.VERSION;this.STATE=Chatterbox.STATE};Chatterbox.UI.prototype.trigger=function(a,b){this.events.emit(a,b,this)};Chatterbox.UI.prototype.on=function(b,a){this.events.addListener(b,a)};Chatterbox.UI.prototype.remove_listeners=function(){this.events.removeListeners()};Chatterbox.UI.prototype.deform_ns=function(a){if(a.indexOf("chat:")==0){return"#"+a.slice(5)}if(a.indexOf("server:")==0){return"~"+a.slice(7)}if(a.indexOf("pchat:")==0){var b=a.split(":");b.shift();for(i in b){name=b[i];if(name.toLowerCase()!=this.lun){return"@"+name}}}if(a.indexOf("login:")==0){return"@"+a.slice(6)}if(a[0]!="#"&&a[0]!="@"&&a[0]!="~"){return"#"+a}return a};Chatterbox.UI.prototype.format_ns=function(a){if(a.indexOf("#")==0){return"chat:"+a.slice(1)}if(a.indexOf("@")==0){var b=[a.slice(1),this.lun];b.sort(caseInsensitiveSort);b.unshift("pchat");return b.join(":")}if(a.indexOf("~")==0){return"server:"+a.slice(1)}if(a.indexOf("chat:")!=0&&a.indexOf("server:")!=0&&a.indexOf("pchat:")!=0){return"chat:"+a}return a};Chatterbox.UI.prototype.set_events=function(a){this.events=a||this.events};Chatterbox.UI.prototype.build=function(f,a,b){this.view.append(Chatterbox.template.ui);this.control=new (f||Chatterbox.Control)(this);this.nav=new (a||Chatterbox.Navigation)(this);this.chatbook=new (b||Chatterbox.Chatbook)(this);hide=this.settings.monitor[1];this.monitoro=this.chatbook.create_channel(this.mns,hide,true);this.control.focus()};Chatterbox.UI.prototype.resize=function(){this.control.resize();this.view.height(this.view.parent().height());this.nav.resize();this.chatbook.resize(this.view.parent().height()-this.nav.height()-this.control.height())};Chatterbox.UI.prototype.create_channel=function(b,a){this.chatbook.create_channel(b,a)};Chatterbox.UI.prototype.remove_channel=function(a){this.chatbook.remove_channel(a)};Chatterbox.UI.prototype.toggle_channel=function(a){return this.chatbook.toggle_channel(a)};Chatterbox.UI.prototype.channel=function(a,b){return this.chatbook.channel(a,b)};Chatterbox.UI.prototype.channels=function(){return this.chatbook.channels()};Chatterbox.UI.prototype.monitor=function(b,a){this.monitoro.server_message(b,a)};Chatterbox.UI.prototype.server_message=function(b,a){this.chatbook.server_message(b,a)};Chatterbox.UI.prototype.log_item=function(a){this.chatbook.log_item(a)};Chatterbox.UI.prototype.log=function(a){this.chatbook.log_item(wsc_html_logmsg.replacePArg("{message}",a))};Chatterbox.UI.prototype.theme=function(a){if(this.settings.theme==a){return}if(this.settings.themes.indexOf(a)==-1){a="wsct_"+a;if(this.settings.themes.indexOf(a)==-1){return}}this.view.removeClass(this.settings.theme).addClass(a);this.settings.theme=a};Chatterbox.UI.prototype.add_theme=function(a){if(this.settings.themes.indexOf(a)>-1){return}this.settings.themes.push(a)};Chatterbox.Channel=function(j,f,g,b){var a=j.deform_ns(f).slice(1).toLowerCase();this.manager=j;this.hidden=g;this.monitor=b||false;this.built=false;this.selector=a;this.raw=j.format_ns(f);this.namespace=j.deform_ns(f)};Chatterbox.Channel.prototype.build=function(){if(this.built){return}var a=this.selector;ns=this.namespace;this.tab=this.manager.nav.add_tab(a,ns);this.tabl=this.tab.find(".tab");this.tabc=this.tab.find(".close");this.manager.chatbook.view.append(Chatterbox.render("channel",{selector:a,ns:ns}));this.window=this.manager.chatbook.view.find("#"+a+"-window");this.logpanel=this.window.find("#"+a+"-log");this.wrap=this.logpanel.find("ul.logwrap");this.userpanel=this.window.find("#"+a+"-users");var f=this;this.tabl.click(function(){f.manager.toggle_channel(a);return false});this.tabc.click(function(g){f.manager.trigger("tab.close.clicked",{ns:f.namespace,chan:f,e:g})});var b=true;this.window.click(function(g){if(b){f.manager.control.focus()}else{b=true}});this.logpanel.select(function(){b=false});if(this.hidden){this.tab.toggleClass("hidden")}this.built=true};Chatterbox.Channel.prototype.hide=function(){this.window.css({display:"none"});this.tab.removeClass("active")};Chatterbox.Channel.prototype.show=function(){this.window.css({display:"block"});this.tab.addClass("active");this.tab.removeClass("noise tabbed fill");this.resize()};Chatterbox.Channel.prototype.remove=function(){this.tab.remove();this.window.remove()};Chatterbox.Channel.prototype.scroll=function(){this.pad();this.wrap.scrollTop(this.wrap.prop("scrollHeight")-this.wrap.innerHeight())};Chatterbox.Channel.prototype.pad=function(){this.wrap.css({"padding-top":0});wh=this.wrap.innerHeight();lh=this.logpanel.innerHeight()-this.logpanel.find("header").height()-3;pad=lh-wh;if(pad>0){this.wrap.css({"padding-top":pad})}else{this.wrap.css({"padding-top":0,height:lh})}};Chatterbox.Channel.prototype.resize=function(){this.wrap.css({"padding-top":0});wh=this.manager.chatbook.height();this.window.height(wh);cw=this.window.width();cu=this.window.find("div.chatusers");title=this.window.find("header div.title");topic=this.window.find("header div.topic");if(cu.css("display")!="none"){cu.width(1);userwidth=cu[0].scrollWidth+this.manager.swidth+10;max=parseInt(cu.css("max-width").slice(0,-2));if(userwidth>max){userwidth=max}cu.width(userwidth);cw=cw-cu.outerWidth()}if(title.css("display")=="block"){wh=wh-title.outerHeight(true)}this.logpanel.css({height:wh-3,width:cw});this.scroll();cu.css({height:this.logpanel.innerHeight()-3})};Chatterbox.Channel.prototype.log=function(a){data={ns:this.namespace,message:a};this.manager.trigger("log.before",data);this.log_item(Chatterbox.render("logmsg",{message:data.message}))};Chatterbox.Channel.prototype.log_item=function(b){var a=new Date().toTimeString().slice(0,8);data={ts:a,message:b};this.manager.trigger("log_item.before",data);this.wrap.append(Chatterbox.render("logitem",{ts:data.ts,message:data.message}));this.manager.trigger("log_item.after",{item:this.wrap.find("li").last()});this.scroll();this.noise()};Chatterbox.Channel.prototype.server_message=function(b,a){data={ns:this.namespace,message:b,info:a};this.manager.trigger("server_message.before",data);this.log_item(Chatterbox.render("servermsg",{message:data.message,info:data.info}))};Chatterbox.Channel.prototype.set_header=function(a,b){headd=this.window.find("header div."+a);headd.replaceWith(Chatterbox.render("header",{head:a,content:b||""}));headd=this.window.find("header div."+a);if(b){headd.css({display:"block"})}else{this.window.find("header div."+a).css({display:"none"})}this.resize()};Chatterbox.Channel.prototype.get_header=function(a){return this.window.find("header div."+a)};Chatterbox.Channel.prototype.set_user_list=function(a){if(Object.size(a)==0){return}infoboxes=[];html="";for(order in a){pc=a[order];html+='<div class="pc"><h3>'+pc.name+"</h3><ul>";for(un in pc.users){user=pc.users[un];conn=user.conn==1?"":"["+user.conn+"]";html+='<li><a target="_blank" id="'+user.name+'" href="http://'+user.name+"."+this.manager.settings.domain+'"><em>'+user.symbol+"</em>"+user.name+"</a>"+conn+"</li>";if(user.hover){infoboxes.push(user.hover)}}html+="</ul></div>"}this.window.find("div.chatusers").html(html);this.userpanel=this.window.find("div.chatusers");this.userpanel.css({display:"block"});for(index in infoboxes){this.userinfo(infoboxes[index])}this.resize()};Chatterbox.Channel.prototype.highlight=function(f){var a=this.tab;(f||this.window.find(".logmsg").last()).addClass("highlight");if(a.hasClass("active")){return}if(a.hasClass("tabbed")){return}var g=0;a.addClass("tabbed");function b(){g++;a.toggleClass("fill");if(g==6){return}setTimeout(b,1000)}b()};Chatterbox.Channel.prototype.noise=function(){if(!this.tab.hasClass("active")){this.tab.addClass("noise")}};Chatterbox.Channel.prototype.userinfo=function(a){var f=this.window.find("a#"+a.name);if(f.length==0){return}var g=this;var b=null;f.hover(function(j){a.info=[];ed={ns:g.namespace,user:a};g.manager.trigger("userinfo.before",ed);a=ed.user;infoli="";for(index in a.info){infoli+="<li>"+a.info[index]+"</li>"}g.window.append(Chatterbox.render("userinfo",{username:a.name,avatar:a.avatar,link:a.link,info:infoli}));b=g.window.find(".userinfo#"+a.name);g.window.find("div.userinfo:not('#"+a.name+"')").remove();pos=f.offset();b.css({top:(pos.top-f.height())+10,left:(pos.left-(b.width()))-6});b.find(".info").height(b.height());b.hover(function(){b.data("hover",1)},function(l){b.data("hover",0);g.unhover_user(b,event)});b.data("hover",0)},function(j){f.data("hover",0);g.unhover_user(b,event)})};Chatterbox.Channel.prototype.unhover_user=function(b,a){o=b.offset();eb=b.outerHeight(true)+o.top;er=b.outerWidth(true)+o.left;x=a.pageX;y=a.pageY;if(x>o.left&&x<er&&y>o.top&&y<eb){return}if(x<(er+15)&&x>o.left&&y>o.top&&y<(o.top+15)){return}b.remove()};Chatterbox.Chatbook=function(a){this.manager=a;this.view=this.manager.view.find("div.chatbook");this.chan={};this.trail=[];this.current=null;this.manager.on("tab.close.clicked",function(b,f){f.chatbook.remove_channel(b.ns)})};Chatterbox.Chatbook.prototype.height=function(){return this.view.height()};Chatterbox.Chatbook.prototype.resize=function(a){a=a||600;this.view.height(a);for(select in this.chan){var b=this.chan[select];b.resize()}};Chatterbox.Chatbook.prototype.channel=function(a,b){a=this.manager.deform_ns(a).slice(1).toLowerCase();if(!this.chan[a]&&b){this.chan[a]=b}return this.chan[a]};Chatterbox.Chatbook.prototype.channels=function(){chans=-1;for(ns in this.chan){if(this.chan[ns].hidden){continue}chans++}return chans};Chatterbox.Chatbook.prototype.create_channel=function(b,f,a){chan=this.channel(b,this.channel_object(b,f,a));chan.build();this.toggle_channel(b);this.manager.resize();return chan};Chatterbox.Chatbook.prototype.channel_object=function(a,b){return new Chatterbox.Channel(this.manager,a,b)};Chatterbox.Chatbook.prototype.toggle_channel=function(a){chan=this.channel(a);prev=chan;if(!chan){return}if(this.current){if(this.current==chan){return}this.current.hide();prev=this.current}chan.show();this.manager.control.focus();this.current=chan;this.manager.resize();pos=this.trail.indexOf(chan.namespace);if(pos>=0){this.trail.splice(pos,1)}this.trail.push(chan.namespace);this.manager.trigger("channel.selected",{ns:chan.namespace,chan:chan,prev:prev})};Chatterbox.Chatbook.prototype.remove_channel=function(a){if(this.channels()==0){return}chan=this.channel(a);chan.remove();delete this.chan[chan.selector];rpos=this.trail.indexOf(chan.namespace);this.trail.splice(rpos,1);if(this.current!=chan){return}select=this.trail[this.trail.length-1];this.toggle_channel(select);this.channel(select).resize()};Chatterbox.Chatbook.prototype.server_message=function(b,a){for(ns in this.chan){this.chan[ns].server_message(b,a)}};Chatterbox.Chatbook.prototype.log_item=function(a){for(ns in this.chan){this.chan[ns].log_item(a)}};Chatterbox.Control=function(a){this.manager=a;this.manager.view.append(Chatterbox.template.control);this.view=this.manager.view.find("div.chatcontrol");this.form=this.view.find("form.msg");this.input=this.form.find("input.msg")};Chatterbox.Control.prototype.focus=function(){this.input.focus()};Chatterbox.Control.prototype.resize=function(){w=this.manager.view.width();this.view.css({width:"100%"});this.form.css({width:this.manager.view.width()-20});this.input.css({width:this.manager.view.width()-80})};Chatterbox.Control.prototype.height=function(){return this.view.height()};Chatterbox.Control.prototype.set_handlers=function(b,a){if(this.manager.mozilla){this.input.keypress(b||this._onkeypress)}else{this.input.keydown(b||this._onkeypress)}this.form.submit(a||this._onsubmit)};Chatterbox.Control.prototype._onkeypress=function(a){};Chatterbox.Control.prototype._onsubmit=function(a){};Chatterbox.Control.prototype.chomp=function(){d=this.input.val();i=d.lastIndexOf(" ");if(i==-1){this.input.val("");return d}chunk=d.slice(i+1);this.input.val(d.slice(0,i));if(chunk.length==0){return this.chomp()}return chunk};Chatterbox.Control.prototype.unchomp=function(a){d=this.input.val();if(!d){this.input.val(a)}else{this.input.val(d+" "+a)}};Chatterbox.Control.prototype.get_text=function(){return this.input.val()};Chatterbox.Control.prototype.set_text=function(a){this.input.val(a||"")};Chatterbox.Navigation=function(a){this.manager=a;this.nav=this.manager.view.find("nav.tabs");this.tabs=this.nav.find("#chattabs");this.buttons=this.nav.find("#tabnav");this.tableft=this.buttons.find(".arrow_left");this.tabright=this.buttons.find(".arrow_right");this.settingsb=this.buttons.find("#settings-button");this.settings={};this.settings.open=false;var b=this;this.settingsb.click(function(g){if(b.settings.open){return false}var f={e:g,settings:new Chatterbox.Settings.Config()};b.manager.trigger("settings.open",f);b.settings.window=new Chatterbox.Settings(b.manager,f.settings);b.settings.window.build();b.settings.open=true;return false})};Chatterbox.Navigation.prototype.height=function(){return this.nav.height()};Chatterbox.Navigation.prototype.add_tab=function(a,b){this.tabs.append(Chatterbox.render("tab",{selector:a,ns:b}));return this.tabs.find("#"+a+"-tab")};Chatterbox.Navigation.prototype.resize=function(){this.tabs.width(this.nav.width()-this.buttons.outerWidth()-20);if(this.settings.open){this.settings.window.resize()}};Chatterbox.Settings=function(b,a){this.manager=b;this.config=a};Chatterbox.Settings.prototype.build=function(){wrap=Chatterbox.template.popup;swindow=Chatterbox.template.settings.main;pages=this.config.render();swindow=replaceAll(swindow,"{tabs}",pages[0]);swindow=replaceAll(swindow,"{pages}",pages[1]);wrap=replaceAll(wrap,"{content}",swindow);wrap=replaceAll(wrap,"{ref}","settings");this.manager.view.append(wrap);this.window=this.manager.view.find(".floater.settings");this.saveb=this.window.find("a.button.save");this.closeb=this.window.find("a.button.close");var a=this;this.saveb.click(function(b){return false});this.closeb.click(function(b){a.window.remove();a.manager.nav.settings.open=false;a.manager.nav.settings.window=null;return false});this.resize()};Chatterbox.Settings.prototype.resize=function(){inner=this.window.find(".inner");head=inner.find("h2");wrap=inner.find(".bookwrap");book=wrap.find(".book");tabs=wrap.find("nav.tabs");foot=inner.find("footer");wrap.height(inner.height()-foot.outerHeight()-head.outerHeight()-10);book.height(wrap.innerHeight()-tabs.outerHeight()-25)};Chatterbox.Settings.Config=function(){this.pages=[]};Chatterbox.Settings.Config.prototype.find_page=function(a){n=a.toLowerCase();for(index in this.pages){page=this.pages[index];if(page.lname==n){return page}}return null};Chatterbox.Settings.Config.prototype.render=function(){pages=["",""];for(i in this.pages){page=this.pages[i];parts=page.render();pages[0]+=parts[0];pages[1]+=parts[1]}return pages};Chatterbox.Settings.Config.prototype.page=function(a){page=this.find_page(a);if(page==null){page=new Chatterbox.Settings.Page(a);this.pages.unshift(page)}return page};Chatterbox.Settings.Page=function(a){this.name=a;this.lname=a.toLowerCase();this.ref=replaceAll(this.lname," ","_");this.items=[]};Chatterbox.Settings.Page.prototype.render=function(){tab=replaceAll(Chatterbox.template.settings.tab,"{ref}",this.ref);tab=replaceAll(tab,"{name}",this.name);page=replaceAll(Chatterbox.template.settings.page,"{ref}",this.ref);page=replaceAll(page,"{content}",this.content());page=replaceAll(page,"{page-name}",this.name);return[tab,page]};Chatterbox.Settings.Page.prototype.content=function(){content="";for(i in this.items){item=this.items[i];content+=item.render()}return content};Chatterbox.Settings.Page.prototype.item=function(b,a){item=new (Chatterbox.Settings.Item[b[0].toUpperCase()+b.substr(1)]||Chatterbox.Settings.Item)(b,a);this.items.push(item);return item};Chatterbox.Settings.Item=function(b,a){this.options=a||{};this.type=b||"base"};Chatterbox.Settings.Item.prototype.render=function(){if(!this.options.hasOwnProperty("ref")){return""}content=this.content();if(content===false){return""}item=replaceAll(Chatterbox.template.settings.item.wrap,"{type}",this.type);item=replaceAll(item,"{ref}",this.options.ref);item=replaceAll(item,"{content}",content);return item};Chatterbox.Settings.Item.prototype.content=function(){if(!Chatterbox.template.settings.item.hasOwnProperty(this.type)){return false}item=Chatterbox.template.settings.item[this.type];if(!item.hasOwnProperty("keys")||!item.hasOwnProperty("frame")){return false}content=item.frame;stub=function(a){return a};for(i in item.keys){key=item.keys[i];if(!this.options.hasOwnProperty(key[0])){return false}content=replaceAll(content,key[1],(key[2]||stub)(this.options[key[0]]))}return content};Chatterbox.Settings.Item.prototype._event_stub=function(){};Chatterbox.template={};Chatterbox.render=function(a,b){html=Chatterbox.template;tparts=a.split(".");for(ind in tparts){part=tparts[ind];if(!html.hasOwnProperty(part)){return""}html=html[part]}for(key in b){if(!b.hasOwnProperty(key)){continue}html=replaceAll(html,"{"+key+"}",b[key])}return html};Chatterbox.template.ui='<nav class="tabs"><ul id="chattabs"></ul>        <ul id="tabnav">            <li><a href="#left" class="button iconic arrow_left"></a></li>            <li><a href="#right" class="button iconic arrow_right"></a></li>            <li><a href="#settings" title="Change client settings" class="button iconic cog" id="settings-button"></a></li>        </ul>        </nav>        <div class="chatbook"></div>';Chatterbox.template.control='<div class="chatcontrol">            <p><a href="#multiline" title="Toggle multiline input" class="button iconic list"></a></p>            <form class="msg">                <input type="text" class="msg" />                <input type="submit" value="Send" class="sendmsg" />            </form>        </div>';Chatterbox.template.tab='<li id="{selector}-tab"><a href="#{selector}" class="tab">{ns}<a href="#{selector}" class="close iconic x"></a></a></li>';Chatterbox.template.channel='<div class="chatwindow" id="{selector}-window">                    <header>                        <div class="title"></div>                    </header>                    <div class="chatlog" id="{selector}-log">                        <header>                            <div class="topic"></div>                        </header>                        <ul class="logwrap"></ul>                    </div>                    <div class="chatusers" id="{selector}-users">                </div>            </div>';Chatterbox.template.header='<div class="{head}">{content}</div>';Chatterbox.template.logmsg='<span class="message">{message}</span>';Chatterbox.template.logitem='<li class="logmsg"><span class="ts">{ts}</span> {message}</li>';Chatterbox.template.servermsg='<span class="servermsg">** {message} * <em>{info}</em></span>';Chatterbox.template.usermsg='<strong class="user">&lt;{user}&gt;</strong> {message}';Chatterbox.template.userinfo='<div class="userinfo" id="{username}">                            <div class="avatar">                                {avatar}                            </div><div class="info">                            <strong>                            {link}                            </strong>                            <ul>{info}</ul></div>                        </div>';Chatterbox.template.popup='<div class="floater {ref}"><div class="inner">{content}</div></div>';Chatterbox.template.settings={};Chatterbox.template.settings.main='<h2>Settings</h2>                            <div class="bookwrap">                                <nav class="tabs">                                    <ul>{tabs}</ul>                                </nav>                                <div class="book">                                    {pages}                                </div>                            </div>                            <footer>                                <a href="#save" class="button save">Save</a> <a href="#close" class="button close">Close</a>                            </footer>';Chatterbox.template.settings.page='<div class="page" id="{ref}-page">                                {content}                            </div>';Chatterbox.template.settings.tab='<li><a href="#{ref}" class="tab" id="{ref}-tab">{name}</a></li>';Chatterbox.template.settings.item={};Chatterbox.template.settings.item.wrap='<div class="item {type} {ref}">                                    {content}                                </div>';Chatterbox.template.settings.item.text={};Chatterbox.template.settings.item.text.keys=[["text","{text}",function(a){return replaceAll(a,"\n\n","\n</p><p>\n")}]];Chatterbox.template.settings.item.text.frame="<p>                                        {text}                                    </p>";(function(a){a("*").hover(function(b){a(this).data("hover",true)},function(b){a(this).data("hover",false)});a.fn.wsc=function(f,b){client=a(window).data("wscclient");if(f=="init"||client===undefined){if(client==undefined){client=new wsc.Client(a(this),b,(a.browser.mozilla||false));a(window).resize(function(){client.ui.resize()});a(window).focus(function(){client.ui.control.focus()});setInterval(function(){client.loop()},120000)}a(window).data("wscclient",client)}if(f!="init"&&f!=undefined){f="jq_"+f;if(f in client){client[f](a(this),b)}}return client};a.fn.wscui=function(f,b){ui=a(window).data("wscui");if(f=="init"||ui===undefined){if(ui==undefined){ui=new WscUI(a(this),b,(a.browser.mozilla||false));a(window).resize(ui.resize)}a(window).data("wscui",ui)}if(f!="init"&&f!=undefined){f="jq_"+f;if(f in ui){ui[f](a(this),b)}}return ui}})(jQuery);