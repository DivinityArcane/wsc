function EventEmitter(){var j={},a=this;function g(q,t){var m=j[q]||false;if(m===false){j[q]=[t];return a}j[q].push(t);return a}function e(m){j[m]=[];return a}function b(v,m){var t=j[v]||false;if(t===false){return a}for(var q in t){if(t.hasOwnProperty(q)){t[q](m)}}return a}function l(m){return j[m]||[]}this.addListener=g;this.removeListeners=e;this.emit=b;this.listeners=l}wsc_html_ui='<ul id="chattabs"></ul>        <div class="chatbook"></div>';wsc_html_control='<div class="chatcontrol">            <p>{user} - {ns}</p>            <form class="msg">                <input type="text" class="msg" />                <input type="submit" value="Send" class="sendmsg" />            </form>        </div>';var wsc_html_chattab='<li id="{selector}-tab"><a href="#{selector}">{ns}</a></li>';var wsc_html_channel='<div class="chatwindow" id="{selector}-window">                    <header>                        <div class="title"></div>                    </header>                    <div class="chatlog" id="{selector}-log">                        <header>                            <div class="topic"></div>                        </header>                        <div class="logwrap"></div>                    </div>                    <div class="chatusers" id="{selector}-users">                </div>            </div>';var wsc_html_cheader='<div class="{head}">{content}</div>';var wsc_html_logmsg='<span class="message">{message}</span>';var wsc_html_logitem='<p class="logmsg"><span class="ts">{ts}</span> {message}</p>';var wsc_html_servermsg='<span class="servermsg">** {message} * <em>{info}</em></span>';var wsc_html_usermsg='<strong class="user">&lt;{user}&gt;</strong> {message}';function $_GET(e,b){b=b||window.location.search;var a=new RegExp("&"+e+"(?:=([^&]*))?(?=&|$)","i");b=b.replace(/^\?/,"&").match(a);if(b){return typeof b[1]!="undefined"?decodeURIComponent(b[1]):""}}function UnixTimestamp(a){ret=new Date(a*1000);return ret}var Months=["January","February","March","April","May","June","July","August","September","October","November","December"];function PosEnd(a){return a=="1"?"st":(a=="2"?"nd":(a=="3"?"rd":"th"))}function DateStamp(a){a=UnixTimestamp(a);date=String(a.getDate());month=a.getMonth();df=date[date.length-1];return date+PosEnd(df)+" of "+Months[month]+", "+a.getFullYear()}function caseInsesitiveSort(g,e){x=String(g).toLowerCase();y=string(e).toLowerCase();return((x>y)?1:(x==y?0:-1))}function CanCreateWebsocket(){if(window.WebSocket){return true}return false}function CreateWebSocket(a,e,g,b){if(!CanCreateWebsocket()){throw"This browser does not support websockets."}ret=new WebSocket(a);if(e){ret.onclose=e}if(g){ret.onmessage=g}if(b){ret.onopen=b}return ret}function EscapeRegExp(a){return a.replace((new RegExp("(\\"+["/",".","*","+","?","|","(",")","[","]","{","}","\\"].join("|\\")+")","g")),"\\$1")}String.prototype.replacePArg=function(b,a){return replaceAll(this,b,a)};String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,e){return typeof a[e]!="undefined"?a[e]:b})};String.prototype.replaceAll=function(b,a){return replaceAllRaw(this,b,a)};replaceAllRaw=function(e,b,a){while(e.indexOf(b)>-1){e=e.replace(b,a)}return e};replaceAll=function(e,b,a){b=new RegExp(EscapeRegExp(b),"g");return e.replace(b,a||"")};Object.size=function(e){var b=0,a;for(a in e){if(e.hasOwnProperty(a)){b++}}return b};function wsc_packet(m){if(!m){return null}try{var l;var t;var b=m.search("\n");if(b==0){return null}var a=m.substr(0,b).replace(/\s*$/,"");l=a.match(/\S+/)[0];var j=a.search(" ");if(j&&j>0){t=a.substr(j+1).match(/\S.*/)[0].replace(/\s*$/,"")}var g=wsc_packet_args(m.substr(b+1));return{cmd:l,param:t,arg:g.args,body:g.data,serialize:function(){return wsc_packetstr(this.cmd,this.param,this.arg,this.body)}}}catch(q){alert("parser exception:"+q);return null}}function wsc_packet_args(l){var e=new Object();var a="";var b=l;while(b&&b.search("\n")){var j=b.search("\n");var g=b.substr(0,j);b=b.substr(j+1);j=g.search("=");if(j==null||j<=0){throw"bad argument line:"+g}an=g.substr(0,j);av=g.substr(j+1);e[an.replace(/\s*$/,"")]=av.replace(/\s*$/,"")}if(b){a=b.substr(1)}return{args:e,data:a}}function wsc_packetstr(j,l,e,a){var b="";if(j){b=j;if(l){b=b+" "+l}}if(e){for(var g in e){b=b+"\n"+g+"="+e[g]}}b=b+"\n";if(a){b=b+"\n"+a}return b}function wsc_packet_serialze(a){return wsc_packetstr(a.cmd,a.param,a.arg,a.body)}function wsc_channel(a,b){var e={client:null,info:{raw:"",selector:"",namespace:"",members:{},pc:{},pc_order:[],title:{content:"",by:"",ts:""},topic:{content:"",by:"",ts:""}},window:null,logpanel:null,wrap:null,userpanel:null,tab:null,built:false,hidden:false,init:function(j,l,m){console.log(l,m);var g=j.deform_ns(l).slice(1).toLowerCase();this.client=j;this.hidden=m;this.info.raw=j.format_ns(l);this.info.selector=g;this.info.namespace=j.deform_ns(l)},build:function(){if(this.built){return}var g=this.info.selector;b=this.info.namespace;this.client.tabul.append(wsc_html_chattab.replacePArg("{selector}",g).replacePArg("{ns}",b));this.client.chatbook.append(wsc_html_channel.replacePArg("{selector}",g).replacePArg("{ns}",b));this.tab=this.client.tabul.find("#"+g+"-tab");this.window=this.client.chatbook.find("#"+g+"-window");this.logpanel=this.client.view.find("#"+g+"-log");this.wrap=this.logpanel.find("div.logwrap");this.userpanel=this.client.view.find("#"+g+"-users");this.client.view.find('a[href="#'+g+'"]').click(function(){e.client.toggleChannel(g);return false});var j=true;this.window.click(function(l){if(j){e.client.control.focus()}else{j=true}});this.logpanel.select(function(){j=false});if(this.hidden){this.tab.toggleClass("hidden");console.log("hey")}this.built=true},invisible:function(){e.hidden=true;this.tab.addClass("hidden")},remove:function(){selector=this.info.selector;this.tab.remove();this.window.remove()},hideChannel:function(){this.window.css({display:"none"});this.tab.removeClass("active")},showChannel:function(){this.window.css({display:"block"});this.tab.addClass("active");this.resize()},toggleTabClass:function(g){this.tab.toggleClass(g)},scroll:function(){this.pad();this.wrap.scrollTop(this.wrap.prop("scrollHeight")-this.wrap.innerHeight())},pad:function(){this.wrap.css({"padding-top":0});wh=this.wrap.innerHeight();lh=this.logpanel.innerHeight()-this.logpanel.find("header").height()-3;pad=lh-wh;if(pad>0){this.wrap.css({"padding-top":pad})}else{this.wrap.css({"padding-top":0,height:lh})}},resize:function(){this.wrap.css({"padding-top":0});wh=this.client.chatbook.height();this.window.height(wh);cw=this.window.width();cu=this.window.find("div.chatusers");title=this.window.find("header div.title");topic=this.window.find("header div.topic");if(cu.css("display")!="none"){cw=cw-cu.outerWidth()}if(title.css("display")=="block"){wh=wh-title.outerHeight(true)}this.logpanel.css({height:wh,width:cw});this.scroll();cu.css({height:this.logpanel.innerHeight()-2})},log:function(g){this.logItem(wsc_html_logmsg.replacePArg("{message}",g))},logItem:function(j){var g=new Date().toTimeString().slice(0,8);this.wrap.append(wsc_html_logitem.replacePArg("{ts}",g).replacePArg("{message}",j));this.scroll()},serverMessage:function(j,g){this.logItem(wsc_html_servermsg.replacePArg("{message}",j).replacePArg("{info}",g))},property:function(g){var j=g.pkt.arg["p"];switch(j){case"title":case"topic":this.setHeader(j,g);break;case"privclasses":this.setPrivclasses(g);break;case"members":this.setMembers(g);break;default:a.monitor("Received unknown property "+j+" received in "+this.info.namespace+".");break}},setHeader:function(g,j){this.info[g]["content"]=j.value||"";this.info[g]["by"]=j.by;this.info[g]["ts"]=j.ts;if(!this.info[g]["content"]){}headd=this.window.find("header div."+g);headd.replaceWith(wsc_html_cheader.replacePArg("{head}",g).replacePArg("{content}",this.info[g]["content"]));headd=this.window.find("header div."+g);if(this.info[g]["content"]){headd.css({display:"block"})}else{this.window.find("header div."+g).css({display:"none"})}this.resize()},setUserList:function(){if(Object.size(this.info.members)==0){return}ulist='<div class="chatusers" id="'+this.info.selector+'-users">';for(var j in this.info.pc_order){pco=this.info.pc_order[j];pc=this.info.pc[pco];pcl="";for(var g in this.info.members){member=this.info.members[g];if(member.pc!=pc){continue}conn=member.conn==1?"":"["+member.conn+"]";s=member.symbol;pcl=pcl+"<li>"+s+'<a target="_blank" href="http://'+g+"."+this.client.settings.domain+'">'+g+"</a>"+conn+"</li>"}if(pcl.length>0){ulist=ulist+'<div class="pc"><h3>'+pc+"</h3><ul>"+pcl+"</ul></div>"}}ulist=ulist+"</div>";this.window.find("div.chatusers").replaceWith(ulist);this.userpanel=this.window.find("div.chatusers");this.userpanel.css({display:"block"});pcs=this.userpanel.find("h3");if(typeof(pcs)=="object"){pcs.addClass("first")}else{for(j in pcs){if(j==0){pcs[0].addClass("first");continue}pcs[j].removeClass("first")}}this.resize();this.client.trigger("set.userlist.wsc",{name:"set.userlist",ns:this.info.namespace})},setPrivclasses:function(l){this.info.pc={};this.info.pc_order=[];var g=l.pkt.body.split("\n");for(var j in g){if(!g[j]){continue}bits=g[j].split(":");this.info.pc_order.push(parseInt(bits[0]));this.info.pc[parseInt(bits[0])]=bits[1]}this.info.pc_order.sort(function(q,m){return m-q})},setMembers:function(g){pack=wsc_packet(g.pkt.body);this.info.members={};while(pack.cmd=="member"){this.registerUser(pack);pack=wsc_packet(pack.body);if(pack==null){break}}this.setUserList()},registerUser:function(g){un=g.param;if(this.info.members[un]==undefined){this.info.members[un]=g.arg;this.info.members[un]["username"]=un;this.info.members[un]["conn"]=1}else{this.info.members[un]["conn"]++}},removeUser:function(g){member=this.info.members[g];if(member==undefined){return}member.conn--;if(member.conn==0){delete this.info.members[g]}},recv_join:function(g){info=wsc_packet("user "+g.user+"\n"+g["*info"]);e.registerUser(info);e.setUserList()},recv_part:function(g){e.removeUser(g.user);e.setUserList()},recv_msg:function(g){u=e.client.settings.username.toLowerCase();msg=g.message.toLowerCase();p=e.window.find("p.logmsg").last();if(msg.indexOf(u)<0||p.html().toLowerCase().indexOf(u)<0){return}p.addClass("highlight")},recv_privchg:function(g){member=e.info.members[g.user];if(!member){return}member.pc=event.pc;e.setUserList()},recv_kicked:function(g){if(!e.info.members[g.user]){return}delete e.info.members[g.user];e.setUserList()}};e.init(a,b);return e}function wsc_tablumps(a){var b={client:null,lumps:null,repl:null,titles:null,subs:null,init:function(l){if(this.expressions){return}var q=l.domain;var j=l.defaultavatar;var e=l.avatarfolder;var g=l.avatarfile;var t=l.emotefolder;var m=l.thumbfolder;this.repl=[/&(\/|)(b|i|u|s|sup|sub|code|p|ul|ol|li|bcode|br|a|iframe)\t/g,"<$1$2>"];this.lumps={"&avatar\t":[2,function(w){un=w[0];icon=w[1];ru=new RegExp("\\$un(\\[([0-9]+)\\])","g");function v(z,B,A){return un[A].toLowerCase()}ico=g.replace(ru,v);ico=icon=="0"?j:ico.replacePArg("{un}",un.toLowerCase());return'<a target="_blank" title=":icon'+un+':" href="http://$1.'+q+'"><img class="avatar"                            alt=":icon$1:" src="'+e+ico+'" height="50" width="50" /></a>'}],"&dev\t":[2,'{0}<a target="_blank" alt=":dev{1}:" href="http://{1}.'+q+'/">{1}</a>'],"&emote\t":[5,'<img alt="{0}" width="{1}" height="{2}" title="{3}" src="'+t+'{4}" />'],"&link\t":[3,'<a target="_blank" href="{0}" title="{2}">{2}</a>'],"&acro\t":[1,'<acronym title="{0}">'],"&abbr\t":[1,'<abbr title="{0}">'],"&thumb\t":[8,function(A,v,F,G,E,D,z,C,B){v=data[0];F=data[1];G=data[2];E=data[3];D=data[4];z=data[5];C=data[6];B=data[7];return'<a target="_blank" href="http://'+E+"."+q+"/art/"+F.replacePArg(" ","-")+"-"+v+'"><img class="thumb" title="'+F+" by "+G+E+", "+D+"x"+z+'" width="'+D+'"                                height="'+z+'" alt=":thumb'+v+':" src="'+m+B.replace(/\:/,"/")+'" /></a>'}],"&img\t":[3,'<img src="{0}" alt="{1}" title="{2}" />'],"&iframe\t":[3,'<iframe src="{0}" width="{1}" height="{2}" />'],"&a\t":[2,'<a target="_blank" href="{0}" title="{1}">'],}},parse:function(e){if(!e){return""}for(tag in this.lumps){while((i=e.indexOf(tag))>-1){info=this.crop(e,tag,i,this.lumps[tag][0]);f=this.lumps[tag][1];if(typeof(f)=="string"){parsed=this.lumps[tag][1].format.apply(this.lumps[tag][1],info[1])}else{parsed=this.lumps[tag][1](info[1])}e=info[0]+parsed+info[2]}}e=e.replace(this.repl[0],this.repl[1]);return e},crop:function(m,e,l,g,j){j=j||"\t";start=m.substring(0,l);rest=m.substring(l+e.length);bits=[];for(i=g;i>0;i--){find=rest.indexOf(j);if(find==-1){break}bits.push(rest.substring(0,find));rest=rest.substring(find+1)}return[start,bits,rest]},};b.init(a);return b}function wsc_protocol(a){var b={client:null,evt_chains:[["recv","admin"]],tablumps:null,maps:{chatserver:["version"],dAmnServer:["version"],login:["username",["e"],"data"],join:["ns",["e"]],part:["ns",["e","*r"]],property:["ns",["p","by","ts"],"*value"],recv_msg:[null,[["from","user"]],"*message"],recv_action:[null,["s",["from","user"]],"*message"],recv_join:["user",["s"],"*info"],recv_part:["user",["s","r"]],recv_privchg:["user",["s","by","pc"]],recv_kicked:["user",["s","by"],"*r"],recv_admin_create:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_update:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_rename:[null,["p",["by","user"],"prev",["name","pc"]]],recv_admin_move:[null,["p",["by","user"],"prev",["name","pc"],["n","affected"]]],recv_admin_remove:[null,["p",["by","user"],["name","pc"],["n","affected"]]],recv_admin_show:[null,["p"],"info"],recv_admin_showverbose:[null,["p"],"info"],recv_admin_privclass:[null,["p","e"],"command"],kicked:["ns",[["by","user"]],"*r"],ping:[],disconnect:[null,["e"]],send:["ns",["e"]],kick:["ns",[["u","user"],"e"]],get:["ns",["p","e"]],set:["ns",["p","e"]],kill:["ns",["e"]],unknown:[null,null,null,null,"packet"],},mapper:{},messages:{chatserver:['<span class="servermsg">** Connected to llama {version} *</span>',false,true],dAmnServer:['<span class="servermsg">** Connected to dAmnServer {version} *</span>',false,true],login:['<span class="servermsg">** Login as {username}: "{e}" *</span>',false,true],join:['<span class="servermsg">** Join {ns}: "{e}" *</span>',true],part:['<span class="servermsg">** Part {ns}: "{e}" * <em>{*r}</em></span>',true],property:['<span class="servermsg">** Got {p} for {ns} *</span>',true],recv_msg:['<span><strong class="user">&lt;{user}&gt;</strong></span><span class="cmsg">{message}</span>'],recv_action:['<span class="caction user"><em>* {user}</em></span><span class="caction">{message}</span>'],recv_join:['<span class="cevent bg">** {user} has joined *</span>'],recv_part:['<span class="cevent bg">** {user} has left * <em>{r}</em></span>'],recv_privchg:['<span class="cevent">** {user} has been made a member of {pc} by {by} *</span>'],recv_kicked:['<span class="cevent">** {user} has been kicked by {by} * <em>{*r}</em></span>'],recv_admin_create:['<span class="cevent admin">** Privilege class {pc} has been created by {user} with: {privs} *</span>'],recv_admin_update:['<span class="cevent admin">** Privilege class {pc} has been updated by {user} with: {privs} *</span>'],recv_admin_rename:['<span class="cevent admin">** Privilege class {prev} has been renamed to {name} by {user} *</span>'],recv_admin_move:['<span class="cevent admin">** All members of {prev} have been moved to {pc} by {user} -- {affected} affected user(s) *</span>'],recv_admin_remove:['<span class="cevent admin">** Privilege class {pc} has been removed by {user} -- {affected} affected user(s) *</span>'],recv_admin_show:null,recv_admin_showverbose:null,recv_admin_privclass:['<span class="cevent admin">** Admin command "{command}" failed: {e} *</span>'],kicked:['<span class="servermsg">** You have been kicked by {user} * <em>{r}</em></span>'],ping:['<span class="servermsg">** Ping...</span>',true],disconnect:['<span class="servermsg">** You have been disconnected * <em>{e}</em></span>',false,true],send:['<span class="servermsg">** Send error: <em>{e}</em></span>'],kick:['<span class="servermsg">** Could not kick {user}: <em>{e}</em></span>'],get:['<span class="servermsg">** Could not get {p} info for {ns}: <em>{e}</em></span>'],set:['<span class="servermsg">** Could not set {p}: <em>{e}</em></span>'],},init:function(e){this.client=e;this.mapper.recv=this.map_recv;this.tablumps=this.client.settings.tablumps(e.settings);e.addListener("chatserver.wsc",this.chatserver);e.addListener("dAmnServer.wsc",this.chatserver);e.addListener("login.wsc",this.login);e.addListener("join.wsc",this.join);e.addListener("part.wsc",this.part);e.addListener("ping.wsc",this.ping);e.addListener("property.wsc",this.property);e.addListener("recv_join.wsc",this.recv_joinpart);e.addListener("recv_part.wsc",this.recv_joinpart);e.addListener("recv_msg.wsc",this.recv_msg);e.addListener("recv_action.wsc",this.recv_msg);e.addListener("recv_privchg.wsc",this.recv_privchg);e.addListener("recv_kicked.wsc",this.recv_kicked)},debug_pkt:function(g){console.log(g.pkt.serialize());console.log(g)},connected:function(e){this.client.trigger("connected.wsc",{name:"connected",pkt:wsc_packet("connected\n\n")});this.client.connected=true;this.client.handshake()},closed:function(e){console.log(e);this.client.trigger("closed.wsc",{name:"closed",pkt:wsc_packet("connection closed\n\n")});this.client.monitorAll("Connection closed");if(this.client.connected){this.client.connected=false}},process_data:function(e){var g=wsc_packet(e.data);if(g==null){return}var j=this.client.event_name(g);pevt=this.packetEvent(j,g);this.log(pevt);this.client.trigger("data.wsc",pevt);this.client.trigger(j+".wsc",pevt)},packetEvent:function(e,g){args={name:e,pkt:g,ns:this.client.mns};if(!this.maps[e]){return args}mapping=this.maps[e];cmd=g.cmd;if(this.mapper[cmd]){this.mapper[cmd](args,g,mapping)}else{this.mapPacket(args,g,mapping)}return args},mapPacket:function(j,e,g){for(i in g){if(g[i]==null){continue}key=g[i];skey=key;switch(i){case"0":j[key]=e.param;break;case"1":for(n in g[1]){key=g[1][n];if(key instanceof Array){j[key[1]]=e.arg[key[0]];skey=key[1]}else{k=key[0]=="*"?key.slice(1):key;j[key]=e.arg[k]||"";skey=key}}break;case"2":if(key instanceof Array){this.mapPacket(j,wsc_packet(e.body),key)}else{j[key]=e.body}break}if(skey[0]!="*"){continue}k=skey.slice(1);j[k]=this.tablumps.parse(j[skey])}},map_recv:function(j,e,g){b.mapPacket(j,e,["ns",null,g])},log:function(e){msgm=b.messages[e.name];if(!msgm){return}msg=msgm[0];if(e.s=="0"){return}for(key in e){d=key=="ns"?b.client.deform_ns(e[key]):e[key];msg=msg.replacePArg("{"+key+"}",d)}if(!msgm[2]){if(!msgm[1]){b.client.channel(e.ns).logItem(msg)}else{b.client.channel(b.client.mns).logItem(msg)}}else{b.client.logItemAll(msg)}},ping:function(e){b.client.pong()},chatserver:function(g){b.client.login()},login:function(g){if(g.pkt.arg["e"]=="ok"){info=wsc_packet("info\n"+g.data);b.client.settings.username=g.pkt.param;b.client.settings.symbol=info.arg.symbol;b.client.settings.userinfo=info.arg;b.client.join(a.settings.autojoin)}else{}},join:function(g){if(g.pkt.arg["e"]=="ok"){ns=b.client.deform_ns(g.pkt.param);b.client.createChannel(ns);b.client.channel(ns).serverMessage("You have joined "+ns)}else{b.client.cchannel.serverMessage("Failed to join "+b.client.deform_ns(g.pkt.param),"["+g.pkt.arg["e"]+"]")}},part:function(g){ns=b.client.deform_ns(g.ns);if(g.e=="ok"){console.log(g);info="";if(g.pkt.arg["r"]){info="["+g.pkt.arg["r"]+"]"}msg="You have left "+ns;c=b.client.channel(ns);c.serverMessage(msg,info);b.client.removeChannel(ns);if(b.client.channels()==0){switch(g.r){case"bad data":case"bad msg":case"msg too big":break;default:if(g.r.indexOf("killed:")<0){return}break}b.process_data({data:"disconnect\ne="+g.r+"\n"})}}else{b.client.monitor("Couldn't leave "+b.client.deform_ns(g.pkt.param),"["+g.pkt.arg["e"]+"]")}},property:function(g){chan=b.client.channel(g.pkt.param);if(!chan){return}chan.property(g)},recv_joinpart:function(g){c=b.client.channel(g.ns);if(g.name=="recv_join"){c.recv_join(g)}else{c.recv_part(g)}},recv_msg:function(g){b.client.channel(g.ns).recv_msg(g)},recv_privchg:function(g){b.client.channel(g.ns).recv_privchg(g)},recv_kicked:function(g){b.client.channel(g.ns).recv_kicked(g)}};b.init(a);return b}function wsc_extdefault(a){var b={client:null,init:function(e){this.client=e;this.client.addListener("cmd.set.wsc",this.setter);this.client.addListener("cmd.connect.wsc",this.connect);this.client.addListener("cmd.join.wsc",this.join);this.client.addListener("cmd.part.wsc",this.part);this.client.addListener("cmd.title.wsc",this.title);this.client.addListener("cmd.promote.wsc",this.promote);this.client.addListener("cmd.me.wsc",this.action);this.client.addListener("cmd.kick.wsc",this.kick);this.client.addListener("cmd.raw.wsc",this.raw);this.client.addListener("cmd.say.wsc",this.say);this.client.addListener("cmd.npmsg.wsc",this.npmsg);this.client.addListener("set.userlist.wsc",this.setUsers)},setter:function(g){data=g.args.split(" ");setting=data.shift().toLowerCase();data=data.join(" ");if(data.length==0){this.client.cchannel.serverMessage("Could not set "+setting,"No data supplied");return}if(!(setting in this.client.settings)){this.client.cchannel.serverMessage('Unknown setting "'+setting+'"');return}this.client.settings[setting]=data;this.client.cchannel.serverMessage("Changed "+setting+" setting","value: "+data);this.client.control.setLabel()},connect:function(g){this.client.connect()},join:function(g){chans=g.args.split(" ");if(g.ns!=g.target){chans.unshift(g.target)}if(chans.toString()==""){return}for(index in chans){b.client.join(chans[index])}},part:function(g){chans=g.args.split(" ");if(g.ns!=g.target){chans.unshift(g.target)}if(chans.toString()==""){b.client.part(g.ns);return}for(index in chans){b.client.part(chans[index])}},title:function(g){b.client.title(g.target,g.args)},promote:function(g){bits=g.args.split(" ");b.client.promote(g.target,bits[0],bits[1])},action:function(g){b.client.action(g.target,g.args)},raw:function(g){b.client.send(g.args.replace(/\\n/gm,"\n"))},kick:function(g){d=g.args.split(" ");u=d.shift();r=d.length>0?d.join(" "):null;b.client.kick(g.target,u,r)},say:function(g){b.client.say(g.target,g.args)},npmsg:function(g){b.client.npmsg(g.target,g.args)},setUsers:function(j){var g=b.client.channel(j.ns);users=g.userpanel.find("li a");users.each(function(z,A){var e=g.userpanel.find(A);var v=e.html();var l=g.info.members[v];var t=null;e.data("hover",0);function m(D,B,E,C){o=D.offset();eb=D.outerHeight(true)+o.top;er=D.outerWidth(true)+o.left;if(B>=o.left&&B<=er&&E>=o.top&&E<=eb){return true}if(C===true){if(B<=(er+30)&&B>=o.left&&E>=o.top&&E<=(o.top+30)){return true}}return false}function q(){t.remove()}ru=new RegExp("\\$un(\\[([0-9]+)\\])","g");function w(B,D,C){return l.username[C].toLowerCase()}e.hover(function(B){g.window.find(this).data("hover",1);rn=l.realname?"<li>"+l.realname+"</li>":"";tn=l.typename?"<li>"+l.typename+"</li>":"";ico=b.client.settings.avatarfile.replace(ru,w);ico=l.usericon=="0"?b.client.settings.defaultavatar:ico.replacePArg("{un}",l.username.toLowerCase());pane='<div class="userinfo" id="'+l.username+'">                                <div class="avatar">                                    <a class="avatar" target="_blank" href="http://'+l.username+"."+b.client.settings.domain+'/">                                        <img class="avatar" alt=":icon'+l.username+':"                                        src="'+b.client.settings.avatarfolder+ico+'" />                                    </a>                                </div><div class="info">                                <strong>                                '+l.symbol+'<a target="_blank" href="http://'+l.username+"."+b.client.settings.domain+'/">'+l.username+"</a>                                </strong>                                <ul>                                    "+rn+tn+"                                </ul></div>                            </div>";g.window.append(pane);t=g.window.find(".userinfo#"+l.username);pos=e.offset();t.css({top:(pos.top-e.height())+10,left:(pos.left-(t.width()))-18});t.hover(function(){g.window.find(this).data("hover",1)},q);t.data("hover",0);box=g.userpanel.find("div.userinfo:not('#"+l.username+"')");box.remove()},function(B){g.window.find(this).data("hover",0);if(m(t,B.pageX,B.pageY,true)){return}q()})})},};b.init(a);return b}function wsc_client(b,e,g){var a={view:null,mozilla:false,control:null,tabul:null,chatbook:null,connected:false,conn:null,evt_chains:[["recv","admin"]],events:null,settings:{domain:"website.com",server:"ws://website.com/wsendpoint",agent:"wsc 0.1a",symbol:"",username:"",userinfo:{},pk:"",monitor:["~Monitor",true],welcome:"Welcome to the wsc web client!",autojoin:"chat:channel",protocol:wsc_protocol,extend:[wsc_extdefault],control:wsc_control,stype:"llama",client:"chatclient",tablumps:wsc_tablumps,avatarfile:"$un[0]/$un[1]/{un}.png",defaultavatar:"default.gif",avatarfolder:"/avatars/",emotefolder:"/emoticons/",thumbfolder:"/thumbs/",},protocol:null,channelo:{},cchannel:null,cmds:[],init:function(j,m,q){j.append('<div class="wsc"></div>');this.view=j.find(".wsc");this.mozilla=q;this.connected=false;this.conn=null;this.events=new EventEmitter();this.view.extend(this.settings,m);this.mns=this.format_ns(this.settings.monitor[0]);this.lun=this.settings.username.toLowerCase();this.channelo={};this.protocol=this.settings.protocol(this);this.cmds=[];for(var l in this.settings.extend){this.settings.extend[l](this)}this.buildUI();this.monitor(this.settings.welcome)},addListener:function(l,j){this.events.addListener(l,function(m){j(m)});jqi=l.indexOf(".wsc");if(l.indexOf("cmd.")!=0||jqi==-1||jqi==4){return}cmd=l.slice(4,jqi).toLowerCase();this.cmds.push(cmd)},removeListeners:function(){this.events.removeListeners()},trigger:function(j,l){this.events.emit(j,l)},channel:function(j,l){j=this.deform_ns(j).slice(1).toLowerCase();if(!this.channelo[j]&&l){this.channelo[j]=l}return this.channelo[j]},channels:function(){chans=-1;for(ns in a.channelo){if(a.channelo[ns].hidden){continue}chans++}return chans},connect:function(){if(a.connected){return}if(CanCreateWebsocket()){a.conn=a.createChatSocket();a.trigger({name:"start.wsc",pkt:wsc_packet("client connecting\ne=ok\n\n")})}else{a.monitor("Your browser does not support WebSockets. Sorry.");a.trigger({name:"start.wsc",pkt:wsc_packet("client connecting\ne=no websockets available\n\n")})}},createChatSocket:function(){var j=this;return CreateWebSocket(this.settings.server,function(l){j.protocol.closed(l)},function(l){j.protocol.process_data(l)},function(l){j.protocol.connected(l)})},buildUI:function(){this.view.append(wsc_html_ui);this.control=this.settings.control(this);this.tabul=this.view.find("#chattabs");this.chatbook=this.view.find("div.chatbook");hide=this.settings.monitor[1];this.createChannel(this.mns,hide);this.control.setInput();this.control.focus();this.resizeUI()},resizeUI:function(){a.control.resize();a.view.height(a.view.parent().height());a.view.width("100%");h=(a.view.parent().height()-a.tabul.outerHeight(true)-a.control.height());a.chatbook.height(h);for(select in a.channelo){chan=a.channel(select);chan.resize()}},createChannel:function(l,j){chan=this.channel(l,wsc_channel(this,l),j);chan.build();this.toggleChannel(l);if(j){chan.invisible()}},removeChannel:function(l){if(this.channels()==0){return}chan=this.channel(l);chan.remove();delete this.channelo[chan.info.selector];var j="";for(tmp in this.channelo){if(this.channelo.hasOwnProperty(tmp)&&tmp!=chan.info.selector){j=tmp}}this.toggleChannel(j);this.channel(j).resize()},toggleChannel:function(j){chan=this.channel(j);if(!chan){return}if(this.cchannel){if(this.cchannel==chan){return}this.cchannel.hideChannel();this.control.cacheInput()}chan.showChannel();this.control.focus();this.cchannel=chan;this.control.setLabel();if(this.settings.monitor[1]){mt=this.tabul.find("#"+this.channel(this.mns).info.selector+"-tab");mt.addClass(this.settings.monitor[1])}this.resizeUI()},log:function(j,m){var l=this.channel(j);if(!l){return}l.log(m)},logAll:function(j){for(ns in this.channelo){this.channlo[ns].log(j)}},logItemAll:function(j){for(ns in this.channelo){this.channelo[ns].logItem(j)}},monitorAll:function(l,j){for(ns in this.channelo){this.channelo[ns].serverMessage(l,j)}},serverMessage:function(j,q,m){var l=this.channel(j);if(!l){return}l.serverMessage(q,m)},monitor:function(l,j){this.serverMessage(this.mns,l,j)},deform_ns:function(l){if(l.indexOf("chat:")==0){return"#"+l.slice(5)}if(l.indexOf("server:")==0){return"~"+l.slice(7)}if(l.indexOf("pchat:")==0){var m=l.split(":");m.shift();for(var j in m){if(j.toLowerCase()!=this.lun){return"@"+j}}}if(l[0]!="#"&&l[0]!="@"&&l[0]!="~"){return"#"+l}return l},format_ns:function(j){if(j.indexOf("#")==0){return"chat:"+j.slice(1)}if(j.indexOf("@")==0){var l=[j.slice(1),this.lun];l.sort(caseInsensitiveSort);l.unshift("pchat");return l.join(":")}if(j.indexOf("~")==0){return"server:"+j.slice(1)}if(j.indexOf("chat:")!=0&&j.indexOf("server:")!=0&&j.indexOf("pchat:")!=0){return"chat:"+j}return j},event_name:function(l){var q=l.cmd;var j=null;for(var m in this.evt_chains){j=this.evt_chains[m];if(j[0]!=q){continue}var t=wsc_packet(l.body);q=q+"_"+t.cmd;if(j.length>1&&t.param!=undefined){if(j[1]==t.cmd){return q+"_"+t.param}}}return q},send:function(j){if(this.connected){return this.conn.send(j)}return -1},handshake:function(){this.send(wsc_packetstr(this.settings.client,"0.3",{agent:this.settings.agent}))},pong:function(){this.send(wsc_packetstr("pong"))},login:function(){pkt="login "+this.settings.username+"\npk="+this.settings.pk+"\n";this.send(pkt)},join:function(j){this.send(wsc_packetstr("join",this.format_ns(j)))},part:function(j){this.send(wsc_packetstr("part",this.format_ns(j)))},promote:function(m,j,l){this.send(wsc_packetstr("send",this.format_ns(m),{},wsc_packetstr("promote",j,{},(!l?"":l))))},say:function(j,l){this.send(wsc_packetstr("send",this.format_ns(j),{},wsc_packetstr("msg","main",{},l)))},npmsg:function(j,l){this.send(wsc_packetstr("send",this.format_ns(j),{},wsc_packetstr("npmsg","main",{},l)))},action:function(j,l){this.send(wsc_packetstr("send",this.format_ns(j),{},wsc_packetstr("action","main",{},l)))},title:function(j,l){this.send(wsc_packetstr("set",this.format_ns(j),{p:"title"},l))},kick:function(l,j,m){this.send(wsc_packetstr("kick",this.format_ns(l),{u:j},m?m:null))},};a.init(b,e,g);return a}function wsc_control(a){var b={client:null,panel:null,form:null,history:{},tab:{hit:false,cache:"",matched:[],index:-1,type:0,prefix:["","/",""],},init:function(e){this.client=e;this.draw();this.panel=this.client.view.find("div.chatcontrol");this.form=this.panel.find("form.msg");this.input=this.form.find("input.msg")},draw:function(){this.client.view.append(wsc_html_control)},focus:function(){b.input.focus()},userLine:function(){return this.client.settings.symbol+this.client.settings.username},resize:function(){this.panel.css({width:"100%"});this.form.css({width:"100%"});this.input.css({width:this.client.cchannel.logpanel.width()-250})},height:function(){return this.panel.height()+20},setLabel:function(){ns=this.client.cchannel.info.namespace;this.panel.find("p").replaceWith("<p>"+this.userLine()+" - "+ns+"</p>");this.untab();h=this.getHistory();this.input.val(h.index==-1?h.tmp:h.list[h.index]);if(h.index==-1){h.tmp=""}},cacheInput:function(){h=this.getHistory();if(h.index>-1){return}h.tmp=this.input.val()},setInput:function(){if(this.client.mozilla){this.input.keypress(this.keypress)}else{this.input.keydown(this.keypress)}this.form.submit(this.submit)},getHistory:function(){ns=this.client.cchannel.info.namespace;if(!this.history[ns]){this.history[ns]={index:-1,list:[],tmp:""}}return this.history[ns]},appendHistory:function(e){if(!e){return}h=this.getHistory();h.list.unshift(e);h.index=-1},scrollHistory:function(e){history=this.getHistory();data=this.input.val();if(history.index==-1){if(data){history.tmp=data}else{history.list[history.index]=data}}if(e){if(history.list.length>0&&history.index<(history.list.length-1)){history.index++}}else{if(history.index>-1){history.index--}}this.setLabel()},keypress:function(e){key=e.which||e.keypress;untab=true;ret=false;switch(key){case 13:b.submit(e);break;case 38:b.scrollHistory(true);break;case 40:b.scrollHistory(false);break;case 9:b.tabItem(e);untab=false;break;default:ret=true;break}if(untab){b.untab(e)}return ret},submit:function(e){msg=b.input.val();b.appendHistory(msg);b.input.val("");b.handleInput(e,msg);return false},untab:function(e){this.tab.hit=false;this.tab.matched=[];this.tab.cache="";this.tab.index=-1},newtab:function(e){this.tab.hit=true;this.tab.index=-1;this.tab.matched=[];this.tab.type=0;needle=this.chomp();this.unchomp(needle);if(needle[0]=="/"||needle[0]=="#"){this.tab.type=needle[0]=="/"?1:2;needle=needle.slice(1)}else{this.tab.type=0}this.tab.cache=needle;needle=needle.toLowerCase();this.tab.matched=[];if(this.tab.type==0){for(user in this.client.cchannel.info.members){if(user.toLowerCase().indexOf(needle)==0){this.tab.matched.push(user)}}}else{if(this.tab.type==1){for(i in this.client.cmds){cmd=this.client.cmds[i];if(cmd.indexOf(needle)==0){this.tab.matched.push(cmd)}}}else{if(this.tab.type==2){for(chan in this.client.channelo){if(chan.toLowerCase().indexOf(needle)==0){this.tab.matched.push(this.client.channel(chan).info.namespace)}}}}}},tabItem:function(e){if(!this.tab.hit){this.newtab(e)}this.chomp();this.tab.index++;if(this.tab.index>=this.tab.matched.length){this.tab.index=-1}if(this.tab.index==-1){this.unchomp(this.tab.prefix[this.tab.type]+this.tab.cache);return}suf=this.input.val()==""&&this.tab.type==0?": ":" ";this.unchomp(this.tab.prefix[this.tab.type]+this.tab.matched[this.tab.index]+suf)},chomp:function(){d=this.input.val();i=d.lastIndexOf(" ");if(i==-1){this.input.val("");return d}r=d.slice(i+1);this.input.val(d.slice(0,i));if(r.length==0){return this.chomp()}return r},unchomp:function(e){d=this.input.val();if(!d){this.input.val(e)}else{this.input.val(d+" "+e)}},handleInput:function(j,g){if(g==""){return}if(g[0]!="/"){if(!this.client.cchannel){return}g=(j.shiftKey?"/npmsg ":"/say ")+g}g=g.slice(1);bits=g.split(" ");cmdn=bits.shift();ens=this.client.cchannel.info.namespace;etarget=ens;if(bits[0]){hash=bits[0][0];if((hash=="#"||hash=="@")&&bits[0].length>1){etarget=this.client.format_ns(bits.shift())}}arg=bits.join(" ");this.client.trigger("cmd."+cmdn+".wsc",{name:"cmd",cmd:cmdn,args:arg,target:etarget,ns:ens})},};b.init(a);return b}(function(a){a("*").hover(function(){a(this).data("hover",true)},function(){a(this).data("hover",false)});a.fn.wsc=function(e,b){client=a(window).data("wscclient");if(e=="init"||client===undefined){if(client==undefined){client=wsc_client(a(this),b,a.browser.mozilla);a(window).resize(client.resizeUI);a(window).focus(function(){client.control.focus()})}a(window).data("wscclient",client)}if(e!="init"&&e!=undefined){pieces=e.split(".");o=client;for(i in pieces){p=pieces[i];if(p in o){o=o[p]}else{return this}}o(a(this),b)}return this}})(jQuery);