function EventEmitter(){var g={},a=this;function f(m,q){var l=g[m]||false;if(l===false){g[m]=[q];return a}g[m].push(q);return a}function e(l){g[l]=[];return a}function b(t,l){var q=g[t]||false;if(q===false){return a}for(var m in q){if(q.hasOwnProperty(m)){q[m](l)}}return a}function j(l){return g[l]||[]}this.addListener=f;this.removeListeners=e;this.emit=b;this.listeners=j}wsc_html_ui='<ul id="chattabs"></ul>        <div class="chatbook"></div>';wsc_html_control='<div class="chatcontrol">            <p>{user} - {ns}</p>            <form class="msg">                <input type="text" class="msg" />                <input type="submit" value="Send" class="sendmsg" />            </form>        </div>';var wsc_html_chattab='<li id="{selector}-tab"><a href="#{selector}">{ns}</a></li>';var wsc_html_channel='<div class="chatwindow" id="{selector}-window">                    <header>                        <div class="title"></div>                    </header>                    <div class="chatlog" id="{selector}-log">                        <header>                            <div class="topic"></div>                        </header>                        <div class="logwrap"></div>                    </div>                    <div class="chatusers" id="{selector}-users">                </div>            </div>';var wsc_html_cheader='<div class="{head}">{content}</div>';var wsc_html_logmsg='<span class="message">{message}</span>';var wsc_html_logitem='<p class="logmsg"><span class="ts">{ts}</span> {message}</p>';var wsc_html_servermsg='<span class="servermsg">** {message} * <em>{info}</em></span>';var wsc_html_usermsg='<strong class="user">&lt;{user}&gt;</strong> {message}';function $_GET(e,b){b=b||window.location.search;var a=new RegExp("&"+e+"(?:=([^&]*))?(?=&|$)","i");b=b.replace(/^\?/,"&").match(a);if(b){return typeof b[1]!="undefined"?decodeURIComponent(b[1]):""}}function UnixTimestamp(a){ret=new Date(a*1000);return ret}var Months=["January","February","March","April","May","June","July","August","September","October","November","December"];function PosEnd(a){return a=="1"?"st":(a=="2"?"nd":(a=="3"?"rd":"th"))}function DateStamp(a){a=UnixTimestamp(a);date=String(a.getDate());month=a.getMonth();df=date[date.length-1];return date+PosEnd(df)+" of "+Months[month]+", "+a.getFullYear()}function caseInsesitiveSort(f,e){x=String(f).toLowerCase();y=string(e).toLowerCase();return((x>y)?1:(x==y?0:-1))}function CanCreateWebsocket(){if(window.WebSocket){return true}return false}function CreateWebSocket(a,e,f,b){if(!CanCreateWebsocket()){throw"This browser does not support websockets."}ret=new WebSocket(a);if(e){ret.onclose=e}if(f){ret.onmessage=f}if(b){ret.onopen=b}return ret}function EscapeRegExp(a){return a.replace((new RegExp("(\\"+["/",".","*","+","?","|","(",")","[","]","{","}","\\"].join("|\\")+")","g")),"\\$1")}String.prototype.replacePArg=function(b,a){return replaceAll(this,b,a)};String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,e){return typeof a[e]!="undefined"?a[e]:b})};String.prototype.replaceAll=function(b,a){return replaceAllRaw(this,b,a)};replaceAllRaw=function(e,b,a){while(e.indexOf(b)>-1){e=e.replace(b,a)}return e};replaceAll=function(e,b,a){b=new RegExp(EscapeRegExp(b),"g");return e.replace(b,a||"")};Object.size=function(e){var b=0,a;for(a in e){if(e.hasOwnProperty(a)){b++}}return b};function wsc_packet(l){if(!l){return null}try{var j;var q;var b=l.search("\n");if(b==0){return null}var a=l.substr(0,b).replace(/\s*$/,"");j=a.match(/\S+/)[0];var g=a.search(" ");if(g&&g>0){q=a.substr(g+1).match(/\S.*/)[0].replace(/\s*$/,"")}var f=wsc_packet_args(l.substr(b+1));return{cmd:j,param:q,arg:f.args,body:f.data,serialize:function(){return wsc_packetstr(this.cmd,this.param,this.arg,this.body)}}}catch(m){alert("parser exception:"+m);return null}}function wsc_packet_args(j){var e=new Object();var a="";var b=j;while(b&&b.search("\n")){var g=b.search("\n");var f=b.substr(0,g);b=b.substr(g+1);g=f.search("=");if(g==null||g<=0){throw"bad argument line:"+f}an=f.substr(0,g);av=f.substr(g+1);e[an.replace(/\s*$/,"")]=av.replace(/\s*$/,"")}if(b){a=b.substr(1)}return{args:e,data:a}}function wsc_packetstr(g,j,e,a){var b="";if(g){b=g;if(j){b=b+" "+j}}if(e){for(var f in e){b=b+"\n"+f+"="+e[f]}}b=b+"\n";if(a){b=b+"\n"+a}return b}function wsc_packet_serialze(a){return wsc_packetstr(a.cmd,a.param,a.arg,a.body)}function wsc_channel(a,b){var e={client:null,info:{raw:"",selector:"",namespace:"",members:{},pc:{},pc_order:[],title:{content:"",by:"",ts:""},topic:{content:"",by:"",ts:""}},window:null,logpanel:null,wrap:null,userpanel:null,tab:null,built:false,hidden:false,init:function(g,j,l){var f=g.deform_ns(j).slice(1).toLowerCase();this.client=g;this.hidden=l;this.info.raw=g.format_ns(j);this.info.selector=f;this.info.namespace=g.deform_ns(j)},build:function(){if(this.built){return}var f=this.info.selector;b=this.info.namespace;this.client.tabul.append(wsc_html_chattab.replacePArg("{selector}",f).replacePArg("{ns}",b));this.client.chatbook.append(wsc_html_channel.replacePArg("{selector}",f).replacePArg("{ns}",b));this.tab=this.client.tabul.find("#"+f+"-tab");this.window=this.client.chatbook.find("#"+f+"-window");this.logpanel=this.client.view.find("#"+f+"-log");this.wrap=this.logpanel.find("div.logwrap");this.userpanel=this.client.view.find("#"+f+"-users");this.client.view.find('a[href="#'+f+'"]').click(function(){e.client.toggleChannel(f);return false});var g=true;this.window.click(function(j){if(g){e.client.control.focus()}else{g=true}});this.logpanel.select(function(){g=false});if(this.hidden){this.tab.toggleClass("hidden");console.log("hey")}this.built=true},invisible:function(){e.hidden=true;e.tab.addClass("hidden")},remove:function(){selector=this.info.selector;this.tab.remove();this.window.remove()},hideChannel:function(){this.window.css({display:"none"});this.tab.removeClass("active")},showChannel:function(){this.window.css({display:"block"});this.tab.addClass("active");this.resize()},toggleTabClass:function(f){this.tab.toggleClass(f)},scroll:function(){this.pad();this.wrap.scrollTop(this.wrap.prop("scrollHeight")-this.wrap.innerHeight())},pad:function(){this.wrap.css({"padding-top":0});wh=this.wrap.innerHeight();lh=this.logpanel.innerHeight()-this.logpanel.find("header").height()-3;pad=lh-wh;if(pad>0){this.wrap.css({"padding-top":pad})}else{this.wrap.css({"padding-top":0,height:lh})}},resize:function(){this.wrap.css({"padding-top":0});wh=this.client.chatbook.height();this.window.height(wh);cw=this.window.width();cu=this.window.find("div.chatusers");title=this.window.find("header div.title");topic=this.window.find("header div.topic");if(cu.css("display")!="none"){cw=cw-cu.outerWidth()}if(title.css("display")=="block"){wh=wh-title.outerHeight(true)}this.logpanel.css({height:wh,width:cw});this.scroll();cu.css({height:this.logpanel.innerHeight()-2})},log:function(f){this.logItem(wsc_html_logmsg.replacePArg("{message}",f))},logItem:function(g){var f=new Date().toTimeString().slice(0,8);this.wrap.append(wsc_html_logitem.replacePArg("{ts}",f).replacePArg("{message}",g));this.scroll()},serverMessage:function(g,f){this.logItem(wsc_html_servermsg.replacePArg("{message}",g).replacePArg("{info}",f))},property:function(f){var g=f.pkt.arg["p"];switch(g){case"title":case"topic":this.setHeader(g,f);break;case"privclasses":this.setPrivclasses(f);break;case"members":this.setMembers(f);break;default:a.monitor("Received unknown property "+g+" received in "+this.info.namespace+".");break}},setHeader:function(f,g){this.info[f]["content"]=g.value||"";this.info[f]["by"]=g.by;this.info[f]["ts"]=g.ts;if(!this.info[f]["content"]){}headd=this.window.find("header div."+f);headd.replaceWith(wsc_html_cheader.replacePArg("{head}",f).replacePArg("{content}",this.info[f]["content"]));headd=this.window.find("header div."+f);if(this.info[f]["content"]){headd.css({display:"block"})}else{this.window.find("header div."+f).css({display:"none"})}this.resize()},setUserList:function(){if(Object.size(this.info.members)==0){return}ulist='<div class="chatusers" id="'+this.info.selector+'-users">';for(var g in this.info.pc_order){pco=this.info.pc_order[g];pc=this.info.pc[pco];pcl="";for(var f in this.info.members){member=this.info.members[f];if(member.pc!=pc){continue}conn=member.conn==1?"":"["+member.conn+"]";s=member.symbol;pcl=pcl+"<li>"+s+'<a target="_blank" href="http://'+f+"."+this.client.settings.domain+'">'+f+"</a>"+conn+"</li>"}if(pcl.length>0){ulist=ulist+'<div class="pc"><h3>'+pc+"</h3><ul>"+pcl+"</ul></div>"}}ulist=ulist+"</div>";this.window.find("div.chatusers").replaceWith(ulist);this.userpanel=this.window.find("div.chatusers");this.userpanel.css({display:"block"});pcs=this.userpanel.find("h3");if(typeof(pcs)=="object"){pcs.addClass("first")}else{for(g in pcs){if(g==0){pcs[0].addClass("first");continue}pcs[g].removeClass("first")}}this.resize();this.client.trigger("set.userlist.wsc",{name:"set.userlist",ns:this.info.namespace})},setPrivclasses:function(j){this.info.pc={};this.info.pc_order=[];var f=j.pkt.body.split("\n");for(var g in f){if(!f[g]){continue}bits=f[g].split(":");this.info.pc_order.push(parseInt(bits[0]));this.info.pc[parseInt(bits[0])]=bits[1]}this.info.pc_order.sort(function(m,l){return l-m})},setMembers:function(f){pack=wsc_packet(f.pkt.body);this.info.members={};while(pack.cmd=="member"){this.registerUser(pack);pack=wsc_packet(pack.body);if(pack==null){break}}this.setUserList()},registerUser:function(f){un=f.param;if(this.info.members[un]==undefined){this.info.members[un]=f.arg;this.info.members[un]["username"]=un;this.info.members[un]["conn"]=1}else{this.info.members[un]["conn"]++}},removeUser:function(f){member=this.info.members[f];if(member==undefined){return}member.conn--;if(member.conn==0){delete this.info.members[f]}},recv_join:function(f){info=wsc_packet("user "+f.user+"\n"+f["*info"]);e.registerUser(info);e.setUserList()},recv_part:function(f){e.removeUser(f.user);e.setUserList()},recv_msg:function(f){u=e.client.settings.username.toLowerCase();msg=f.message.toLowerCase();p=e.window.find("p.logmsg").last();if(msg.indexOf(u)<0||p.html().toLowerCase().indexOf(u)<0){return}p.addClass("highlight")},recv_privchg:function(f){member=e.info.members[f.user];if(!member){return}member.pc=event.pc;e.setUserList()},recv_kicked:function(f){if(!e.info.members[f.user]){return}delete e.info.members[f.user];e.setUserList()}};e.init(a,b);return e}function wsc_tablumps(a){var b={client:null,lumps:null,repl:null,init:function(j){if(this.expressions){return}var m=j.domain;var g=j.defaultavatar;var e=j.avatarfolder;var f=j.avatarfile;var q=j.emotefolder;var l=j.thumbfolder;this.repl=[/&(\/|)(b|i|u|s|sup|sub|code|p|ul|ol|li|bcode|a|iframe|acro|abbr)\t/g,"<$1$2>"];this.lumps={"&avatar\t":[2,function(v){un=v[0];icon=v[1];ru=new RegExp("\\$un(\\[([0-9]+)\\])","g");function t(w,A,z){return un[z].toLowerCase()}ico=f.replace(ru,t);ico=icon=="0"?g:ico.replacePArg("{un}",un.toLowerCase());return'<a target="_blank" title=":icon'+un+':" href="http://$1.'+m+'"><img class="avatar"                            alt=":icon$1:" src="'+e+ico+'" height="50" width="50" /></a>'}],"&emote\t":[5,'<img alt="{0}" width="{1}" height="{2}" title="{3}" src="'+q+'{4}" />'],"&link\t":[3,'<a target="_blank" href="{0}" title="{2}">{2}</a>'],"&acro\t":[1,'<acronym title="{0}">'],"&abbr\t":[1,'<abbr title="{0}">'],"&img\t":[3,'<img src="{0}" alt="{1}" title="{2}" />'],"&iframe\t":[3,'<iframe src="{0}" width="{1}" height="{2}" />'],"&a\t":[2,'<a target="_blank" href="{0}" title="{1}">'],"&br\t":[0,"<br/>"]}},parse:function(e){if(!e){return""}for(i=0;i<e.length;i++){if(e[i]!="&"){continue}primer=e.substring(0,i);working=e.substring(i);ti=working.indexOf("\t");if(ti==-1){continue}tag=working.substring(0,ti+1);working=working.substring(ti+1);lump=this.lumps[tag];if(lump===undefined){continue}cropping=this.tokens(working,lump[0]);if(typeof(lump[1])=="string"){parsed=lump[1].format.apply(lump[1],cropping[0])}else{parsed=lump[1](cropping[0])}e=primer+parsed+cropping[1];i=i+(parsed.length-2)}e=e.replace(this.repl[0],this.repl[1]);return e},tokens:function(g,e,f){f=f||"\t";tokens=[];for(i=e;i>0;i--){find=g.indexOf(f);if(find==-1){break}tokens.push(g.substring(0,find));g=g.substring(find+1)}return[tokens,g]},};b.init(a);return b}function wsc_protocol(a){var b={client:null,evt_chains:[["recv","admin"]],tablumps:null,maps:{chatserver:["version"],dAmnServer:["version"],login:["username",["e"],"data"],join:["ns",["e"]],part:["ns",["e","*r"]],property:["ns",["p","by","ts"],"*value"],recv_msg:[null,[["from","user"]],"*message"],recv_npmsg:[null,[["from","user"]],"message"],recv_action:[null,["s",["from","user"]],"*message"],recv_join:["user",["s"],"*info"],recv_part:["user",["s","r"]],recv_privchg:["user",["s","by","pc"]],recv_kicked:["user",["s","by"],"*r"],recv_admin_create:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_update:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_rename:[null,["p",["by","user"],"prev",["name","pc"]]],recv_admin_move:[null,["p",["by","user"],"prev",["name","pc"],["n","affected"]]],recv_admin_remove:[null,["p",["by","user"],["name","pc"],["n","affected"]]],recv_admin_show:[null,["p"],"info"],recv_admin_showverbose:[null,["p"],"info"],recv_admin_privclass:[null,["p","e"],"command"],kicked:["ns",[["by","user"]],"*r"],ping:[],disconnect:[null,["e"]],send:["ns",["e"]],kick:["ns",[["u","user"],"e"]],get:["ns",["p","e"]],set:["ns",["p","e"]],kill:["ns",["e"]],unknown:[null,null,null,null,"packet"],},mapper:{},messages:{chatserver:['<span class="servermsg">** Connected to llama {version} *</span>',false,true],dAmnServer:['<span class="servermsg">** Connected to dAmnServer {version} *</span>',false,true],login:['<span class="servermsg">** Login as {username}: "{e}" *</span>',false,true],join:['<span class="servermsg">** Join {ns}: "{e}" *</span>',true],part:['<span class="servermsg">** Part {ns}: "{e}" * <em>{*r}</em></span>',true],property:['<span class="servermsg">** Got {p} for {ns} *</span>',true],recv_msg:['<span><strong class="user">&lt;{user}&gt;</strong></span><span class="cmsg">{message}</span>'],recv_action:['<span class="caction user"><em>* {user}</em></span><span class="caction">{message}</span>'],recv_join:['<span class="cevent bg">** {user} has joined *</span>'],recv_part:['<span class="cevent bg">** {user} has left * <em>{r}</em></span>'],recv_privchg:['<span class="cevent">** {user} has been made a member of {pc} by {by} *</span>'],recv_kicked:['<span class="cevent">** {user} has been kicked by {by} * <em>{*r}</em></span>'],recv_admin_create:['<span class="cevent admin">** Privilege class {pc} has been created by {user} with: {privs} *</span>'],recv_admin_update:['<span class="cevent admin">** Privilege class {pc} has been updated by {user} with: {privs} *</span>'],recv_admin_rename:['<span class="cevent admin">** Privilege class {prev} has been renamed to {name} by {user} *</span>'],recv_admin_move:['<span class="cevent admin">** All members of {prev} have been moved to {pc} by {user} -- {affected} affected user(s) *</span>'],recv_admin_remove:['<span class="cevent admin">** Privilege class {pc} has been removed by {user} -- {affected} affected user(s) *</span>'],recv_admin_show:null,recv_admin_showverbose:null,recv_admin_privclass:['<span class="cevent admin">** Admin command "{command}" failed: {e} *</span>'],kicked:['<span class="servermsg">** You have been kicked by {user} * <em>{r}</em></span>'],ping:['<span class="servermsg">** Ping...</span>',true],disconnect:['<span class="servermsg">** You have been disconnected * <em>{e}</em></span>',false,true],send:['<span class="servermsg">** Send error: <em>{e}</em></span>'],kick:['<span class="servermsg">** Could not kick {user}: <em>{e}</em></span>'],get:['<span class="servermsg">** Could not get {p} info for {ns}: <em>{e}</em></span>'],set:['<span class="servermsg">** Could not set {p}: <em>{e}</em></span>'],},init:function(e){this.client=e;this.mapper.recv=this.map_recv;this.tablumps=this.client.settings.tablumps(e.settings);e.addListener("chatserver.wsc",this.chatserver);e.addListener("dAmnServer.wsc",this.chatserver);e.addListener("login.wsc",this.login);e.addListener("join.wsc",this.join);e.addListener("part.wsc",this.part);e.addListener("ping.wsc",this.ping);e.addListener("property.wsc",this.property);e.addListener("recv_join.wsc",this.recv_joinpart);e.addListener("recv_part.wsc",this.recv_joinpart);e.addListener("recv_msg.wsc",this.recv_msg);e.addListener("recv_action.wsc",this.recv_msg);e.addListener("recv_privchg.wsc",this.recv_privchg);e.addListener("recv_kicked.wsc",this.recv_kicked)},debug_pkt:function(f){console.log(f.pkt.serialize());console.log(f)},connected:function(e){this.client.trigger("connected.wsc",{name:"connected",pkt:wsc_packet("connected\n\n")});this.client.connected=true;this.client.handshake()},closed:function(e){console.log(e);this.client.trigger("closed.wsc",{name:"closed",pkt:wsc_packet("connection closed\n\n")});this.client.monitorAll("Connection closed");if(this.client.connected){this.client.connected=false}},process_data:function(e){var f=wsc_packet(e.data);if(f==null){return}var g=this.client.event_name(f);pevt=this.packetEvent(g,f);this.log(pevt);this.client.trigger("data.wsc",pevt);this.client.trigger(g+".wsc",pevt)},packetEvent:function(e,f){args={name:e,pkt:f,ns:this.client.mns};if(!this.maps[e]){return args}mapping=this.maps[e];cmd=f.cmd;if(this.mapper[cmd]){this.mapper[cmd](args,f,mapping)}else{this.mapPacket(args,f,mapping)}return args},mapPacket:function(g,e,f){for(i in f){if(f[i]==null){continue}key=f[i];skey=key;switch(i){case"0":g[key]=e.param;break;case"1":for(n in f[1]){key=f[1][n];if(key instanceof Array){g[key[1]]=e.arg[key[0]];skey=key[1]}else{k=key[0]=="*"?key.slice(1):key;g[key]=e.arg[k]||"";skey=key}}break;case"2":if(key instanceof Array){this.mapPacket(g,wsc_packet(e.body),key)}else{g[key]=e.body}break}if(skey[0]!="*"){continue}k=skey.slice(1);g[k]=this.tablumps.parse(g[skey])}},map_recv:function(g,e,f){b.mapPacket(g,e,["ns",null,f])},log:function(e){msgm=b.messages[e.name];if(!msgm){return}msg=msgm[0];if(e.s=="0"){return}for(key in e){d=key=="ns"?b.client.deform_ns(e[key]):e[key];msg=msg.replacePArg("{"+key+"}",d)}if(!msgm[2]){if(!msgm[1]){b.client.channel(e.ns).logItem(msg)}else{b.client.channel(b.client.mns).logItem(msg)}}else{b.client.logItemAll(msg)}},ping:function(e){b.client.pong()},chatserver:function(f){b.client.login()},login:function(f){if(f.pkt.arg["e"]=="ok"){info=wsc_packet("info\n"+f.data);b.client.settings.username=f.pkt.param;b.client.settings.symbol=info.arg.symbol;b.client.settings.userinfo=info.arg;b.client.join(a.settings.autojoin)}else{}},join:function(f){if(f.pkt.arg["e"]=="ok"){ns=b.client.deform_ns(f.pkt.param);b.client.createChannel(ns);b.client.channel(ns).serverMessage("You have joined "+ns)}else{b.client.cchannel.serverMessage("Failed to join "+b.client.deform_ns(f.pkt.param),"["+f.pkt.arg["e"]+"]")}},part:function(f){ns=b.client.deform_ns(f.ns);if(f.e=="ok"){console.log(f);info="";if(f.pkt.arg["r"]){info="["+f.pkt.arg["r"]+"]"}msg="You have left "+ns;c=b.client.channel(ns);c.serverMessage(msg,info);b.client.removeChannel(ns);if(b.client.channels()==0){switch(f.r){case"bad data":case"bad msg":case"msg too big":break;default:if(f.r.indexOf("killed:")<0){return}break}b.process_data({data:"disconnect\ne="+f.r+"\n"})}}else{b.client.monitor("Couldn't leave "+b.client.deform_ns(f.pkt.param),"["+f.pkt.arg["e"]+"]")}},property:function(f){chan=b.client.channel(f.pkt.param);if(!chan){return}chan.property(f)},recv_joinpart:function(f){c=b.client.channel(f.ns);if(f.name=="recv_join"){c.recv_join(f)}else{c.recv_part(f)}},recv_msg:function(f){b.client.channel(f.ns).recv_msg(f)},recv_privchg:function(f){b.client.channel(f.ns).recv_privchg(f)},recv_kicked:function(f){b.client.channel(f.ns).recv_kicked(f)}};b.init(a);return b}function wsc_extbase(a){var b={client:null,init:function(e){this.client=e},};b.init(a);return b}function wsc_extdefault(a){var b=wsc_extbase(a);b.register=function(){this.client.addListener("cmd.set.wsc",this.setter);this.client.addListener("cmd.connect.wsc",this.connect);this.client.addListener("cmd.join.wsc",this.join);this.client.addListener("cmd.part.wsc",this.part);this.client.addListener("cmd.title.wsc",this.title);this.client.addListener("cmd.promote.wsc",this.promote);this.client.addListener("cmd.me.wsc",this.action);this.client.addListener("cmd.kick.wsc",this.kick);this.client.addListener("cmd.raw.wsc",this.raw);this.client.addListener("cmd.say.wsc",this.say);this.client.addListener("cmd.npmsg.wsc",this.npmsg);this.client.addListener("set.userlist.wsc",this.setUsers)};b.setter=function(f){data=f.args.split(" ");setting=data.shift().toLowerCase();data=data.join(" ");if(data.length==0){this.client.cchannel.serverMessage("Could not set "+setting,"No data supplied");return}if(!(setting in this.client.settings)){this.client.cchannel.serverMessage('Unknown setting "'+setting+'"');return}this.client.settings[setting]=data;this.client.cchannel.serverMessage("Changed "+setting+" setting","value: "+data);this.client.control.setLabel()};b.connect=function(f){this.client.connect()};b.join=function(f){chans=f.args.split(" ");if(f.ns!=f.target){chans.unshift(f.target)}if(chans.toString()==""){return}for(index in chans){b.client.join(chans[index])}};b.part=function(f){chans=f.args.split(" ");if(f.ns!=f.target){chans.unshift(f.target)}if(chans.toString()==""){b.client.part(f.ns);return}for(index in chans){b.client.part(chans[index])}};b.title=function(f){b.client.title(f.target,f.args)};b.promote=function(f){bits=f.args.split(" ");b.client.promote(f.target,bits[0],bits[1])};b.action=function(f){b.client.action(f.target,f.args)};b.raw=function(f){b.client.send(f.args.replace(/\\n/gm,"\n"))};b.kick=function(f){d=f.args.split(" ");u=d.shift();r=d.length>0?d.join(" "):null;b.client.kick(f.target,u,r)};b.say=function(f){b.client.say(f.target,f.args)};b.npmsg=function(f){b.client.npmsg(f.target,f.args)};b.setUsers=function(g){var f=b.client.channel(g.ns);users=f.userpanel.find("li a");users.each(function(w,z){var e=f.userpanel.find(z);var t=e.html();var j=f.info.members[t];var q=null;e.data("hover",0);function l(C,A,D,B){o=C.offset();eb=C.outerHeight(true)+o.top;er=C.outerWidth(true)+o.left;if(A>=o.left&&A<=er&&D>=o.top&&D<=eb){return true}if(B===true){if(A<=(er+30)&&A>=o.left&&D>=o.top&&D<=(o.top+30)){return true}}return false}function m(){q.remove()}ru=new RegExp("\\$un(\\[([0-9]+)\\])","g");function v(A,C,B){return j.username[B].toLowerCase()}e.hover(function(A){f.window.find(this).data("hover",1);rn=j.realname?"<li>"+j.realname+"</li>":"";tn=j.typename?"<li>"+j.typename+"</li>":"";ico=b.client.settings.avatarfile.replace(ru,v);ico=j.usericon=="0"?b.client.settings.defaultavatar:ico.replacePArg("{un}",j.username.toLowerCase());pane='<div class="userinfo" id="'+j.username+'">                            <div class="avatar">                                <a class="avatar" target="_blank" href="http://'+j.username+"."+b.client.settings.domain+'/">                                    <img class="avatar" alt=":icon'+j.username+':"                                    src="'+b.client.settings.avatarfolder+ico+'" />                                </a>                            </div><div class="info">                            <strong>                            '+j.symbol+'<a target="_blank" href="http://'+j.username+"."+b.client.settings.domain+'/">'+j.username+"</a>                            </strong>                            <ul>                                "+rn+tn+"                            </ul></div>                        </div>";f.window.append(pane);q=f.window.find(".userinfo#"+j.username);pos=e.offset();q.css({top:(pos.top-e.height())+10,left:(pos.left-(q.width()))-18});q.hover(function(){f.window.find(this).data("hover",1)},m);q.data("hover",0);box=f.userpanel.find("div.userinfo:not('#"+j.username+"')");box.remove()},function(A){f.window.find(this).data("hover",0);if(l(q,A.pageX,A.pageY,true)){return}m()})})};b.register();return b}function wsc_client(b,e,f){var a={view:null,mozilla:false,control:null,tabul:null,chatbook:null,connected:false,conn:null,evt_chains:[["recv","admin"]],events:null,settings:{domain:"website.com",server:"ws://website.com/wsendpoint",agent:"wsc 0.1a",symbol:"",username:"",userinfo:{},pk:"",monitor:["~Monitor",true],welcome:"Welcome to the wsc web client!",autojoin:"chat:channel",protocol:wsc_protocol,extend:[wsc_extdefault],control:wsc_control,stype:"llama",client:"chatclient",tablumps:wsc_tablumps,avatarfile:"$un[0]/$un[1]/{un}.png",defaultavatar:"default.gif",avatarfolder:"/avatars/",emotefolder:"/emoticons/",thumbfolder:"/thumbs/",},protocol:null,channelo:{},cchannel:null,cmds:[],init:function(g,l,m){g.append('<div class="wsc"></div>');this.view=g.find(".wsc");this.mozilla=m;this.connected=false;this.conn=null;this.events=new EventEmitter();this.view.extend(this.settings,l);this.mns=this.format_ns(this.settings.monitor[0]);this.lun=this.settings.username.toLowerCase();this.channelo={};this.protocol=this.settings.protocol(this);this.cmds=[];for(var j in this.settings.extend){this.settings.extend[j](this)}this.buildUI();this.monitor(this.settings.welcome)},addListener:function(j,g){this.events.addListener(j,function(l){g(l)});jqi=j.indexOf(".wsc");if(j.indexOf("cmd.")!=0||jqi==-1||jqi==4){return}cmd=j.slice(4,jqi).toLowerCase();this.cmds.push(cmd)},removeListeners:function(){this.events.removeListeners()},trigger:function(g,j){this.events.emit(g,j)},channel:function(g,j){g=this.deform_ns(g).slice(1).toLowerCase();if(!this.channelo[g]&&j){this.channelo[g]=j}return this.channelo[g]},channels:function(){chans=-1;for(ns in a.channelo){if(a.channelo[ns].hidden){continue}chans++}return chans},connect:function(){if(a.connected){return}if(CanCreateWebsocket()){a.conn=a.createChatSocket();a.trigger({name:"start.wsc",pkt:wsc_packet("client connecting\ne=ok\n\n")})}else{a.monitor("Your browser does not support WebSockets. Sorry.");a.trigger({name:"start.wsc",pkt:wsc_packet("client connecting\ne=no websockets available\n\n")})}},createChatSocket:function(){var g=this;return CreateWebSocket(this.settings.server,function(j){g.protocol.closed(j)},function(j){g.protocol.process_data(j)},function(j){g.protocol.connected(j)})},buildUI:function(){this.view.append(wsc_html_ui);this.control=this.settings.control(this);this.tabul=this.view.find("#chattabs");this.chatbook=this.view.find("div.chatbook");hide=this.settings.monitor[1];this.createChannel(this.mns,hide);this.control.setInput();this.control.focus();this.resizeUI()},resizeUI:function(){a.control.resize();a.view.height(a.view.parent().height());a.view.width("100%");h=(a.view.parent().height()-a.tabul.outerHeight(true)-a.control.height());a.chatbook.height(h);for(select in a.channelo){chan=a.channel(select);chan.resize()}},createChannel:function(j,g){chan=this.channel(j,wsc_channel(this,j),g);chan.build();this.toggleChannel(j);if(g){chan.invisible()}},removeChannel:function(j){if(this.channels()==0){return}chan=this.channel(j);chan.remove();delete this.channelo[chan.info.selector];var g="";for(tmp in this.channelo){if(this.channelo.hasOwnProperty(tmp)&&tmp!=chan.info.selector){g=tmp}}this.toggleChannel(g);this.channel(g).resize()},toggleChannel:function(g){chan=this.channel(g);if(!chan){return}if(this.cchannel){if(this.cchannel==chan){return}this.cchannel.hideChannel();this.control.cacheInput()}chan.showChannel();this.control.focus();this.cchannel=chan;this.control.setLabel();if(this.settings.monitor[1]){mt=this.tabul.find("#"+this.channel(this.mns).info.selector+"-tab");mt.addClass(this.settings.monitor[1])}this.resizeUI()},log:function(g,l){var j=this.channel(g);if(!j){return}j.log(l)},logAll:function(g){for(ns in this.channelo){this.channlo[ns].log(g)}},logItemAll:function(g){for(ns in this.channelo){this.channelo[ns].logItem(g)}},monitorAll:function(j,g){for(ns in this.channelo){this.channelo[ns].serverMessage(j,g)}},serverMessage:function(g,m,l){var j=this.channel(g);if(!j){return}j.serverMessage(m,l)},monitor:function(j,g){this.serverMessage(this.mns,j,g)},deform_ns:function(j){if(j.indexOf("chat:")==0){return"#"+j.slice(5)}if(j.indexOf("server:")==0){return"~"+j.slice(7)}if(j.indexOf("pchat:")==0){var l=j.split(":");l.shift();for(var g in l){if(g.toLowerCase()!=this.lun){return"@"+g}}}if(j[0]!="#"&&j[0]!="@"&&j[0]!="~"){return"#"+j}return j},format_ns:function(g){if(g.indexOf("#")==0){return"chat:"+g.slice(1)}if(g.indexOf("@")==0){var j=[g.slice(1),this.lun];j.sort(caseInsensitiveSort);j.unshift("pchat");return j.join(":")}if(g.indexOf("~")==0){return"server:"+g.slice(1)}if(g.indexOf("chat:")!=0&&g.indexOf("server:")!=0&&g.indexOf("pchat:")!=0){return"chat:"+g}return g},event_name:function(j){var m=j.cmd;var g=null;for(var l in this.evt_chains){g=this.evt_chains[l];if(g[0]!=m){continue}var q=wsc_packet(j.body);m=m+"_"+q.cmd;if(g.length>1&&q.param!=undefined){if(g[1]==q.cmd){return m+"_"+q.param}}}return m},send:function(g){if(this.connected){return this.conn.send(g)}return -1},handshake:function(){this.send(wsc_packetstr(this.settings.client,"0.3",{agent:this.settings.agent}))},pong:function(){this.send(wsc_packetstr("pong"))},login:function(){pkt="login "+this.settings.username+"\npk="+this.settings.pk+"\n";this.send(pkt)},join:function(g){this.send(wsc_packetstr("join",this.format_ns(g)))},part:function(g){this.send(wsc_packetstr("part",this.format_ns(g)))},promote:function(l,g,j){this.send(wsc_packetstr("send",this.format_ns(l),{},wsc_packetstr("promote",g,{},(!j?"":j))))},say:function(g,j){this.send(wsc_packetstr("send",this.format_ns(g),{},wsc_packetstr("msg","main",{},j)))},npmsg:function(g,j){this.send(wsc_packetstr("send",this.format_ns(g),{},wsc_packetstr("npmsg","main",{},j)))},action:function(g,j){this.send(wsc_packetstr("send",this.format_ns(g),{},wsc_packetstr("action","main",{},j)))},title:function(g,j){this.send(wsc_packetstr("set",this.format_ns(g),{p:"title"},j))},kick:function(j,g,l){this.send(wsc_packetstr("kick",this.format_ns(j),{u:g},l?l:null))},};a.init(b,e,f);return a}function wsc_control(a){var b={client:null,panel:null,form:null,history:{},tab:{hit:false,cache:"",matched:[],index:-1,type:0,prefix:["","/",""],},init:function(e){this.client=e;this.draw();this.panel=this.client.view.find("div.chatcontrol");this.form=this.panel.find("form.msg");this.input=this.form.find("input.msg")},draw:function(){this.client.view.append(wsc_html_control)},focus:function(){b.input.focus()},userLine:function(){return this.client.settings.symbol+this.client.settings.username},resize:function(){this.panel.css({width:"100%"});this.form.css({width:"100%"});this.input.css({width:this.client.cchannel.logpanel.width()-250})},height:function(){return this.panel.height()+20},setLabel:function(){ns=this.client.cchannel.info.namespace;this.panel.find("p").replaceWith("<p>"+this.userLine()+" - "+ns+"</p>");this.untab();h=this.getHistory();this.input.val(h.index==-1?h.tmp:h.list[h.index]);if(h.index==-1){h.tmp=""}},cacheInput:function(){h=this.getHistory();if(h.index>-1){return}h.tmp=this.input.val()},setInput:function(){if(this.client.mozilla){this.input.keypress(this.keypress)}else{this.input.keydown(this.keypress)}this.form.submit(this.submit)},getHistory:function(){ns=this.client.cchannel.info.namespace;if(!this.history[ns]){this.history[ns]={index:-1,list:[],tmp:""}}return this.history[ns]},appendHistory:function(e){if(!e){return}h=this.getHistory();h.list.unshift(e);h.index=-1},scrollHistory:function(e){history=this.getHistory();data=this.input.val();if(history.index==-1){if(data){history.tmp=data}else{history.list[history.index]=data}}if(e){if(history.list.length>0&&history.index<(history.list.length-1)){history.index++}}else{if(history.index>-1){history.index--}}this.setLabel()},keypress:function(e){key=e.which||e.keypress;untab=true;ret=false;switch(key){case 13:b.submit(e);break;case 38:b.scrollHistory(true);break;case 40:b.scrollHistory(false);break;case 9:b.tabItem(e);untab=false;break;default:ret=true;break}if(untab){b.untab(e)}return ret},submit:function(e){msg=b.input.val();b.appendHistory(msg);b.input.val("");b.handleInput(e,msg);return false},untab:function(e){this.tab.hit=false;this.tab.matched=[];this.tab.cache="";this.tab.index=-1},newtab:function(e){this.tab.hit=true;this.tab.index=-1;this.tab.matched=[];this.tab.type=0;needle=this.chomp();this.unchomp(needle);if(needle[0]=="/"||needle[0]=="#"){this.tab.type=needle[0]=="/"?1:2;needle=needle.slice(1)}else{this.tab.type=0}this.tab.cache=needle;needle=needle.toLowerCase();this.tab.matched=[];if(this.tab.type==0){for(user in this.client.cchannel.info.members){if(user.toLowerCase().indexOf(needle)==0){this.tab.matched.push(user)}}}else{if(this.tab.type==1){for(i in this.client.cmds){cmd=this.client.cmds[i];if(cmd.indexOf(needle)==0){this.tab.matched.push(cmd)}}}else{if(this.tab.type==2){for(chan in this.client.channelo){if(chan.toLowerCase().indexOf(needle)==0){this.tab.matched.push(this.client.channel(chan).info.namespace)}}}}}},tabItem:function(e){if(!this.tab.hit){this.newtab(e)}this.chomp();this.tab.index++;if(this.tab.index>=this.tab.matched.length){this.tab.index=-1}if(this.tab.index==-1){this.unchomp(this.tab.prefix[this.tab.type]+this.tab.cache);return}suf=this.input.val()==""&&this.tab.type==0?": ":" ";this.unchomp(this.tab.prefix[this.tab.type]+this.tab.matched[this.tab.index]+suf)},chomp:function(){d=this.input.val();i=d.lastIndexOf(" ");if(i==-1){this.input.val("");return d}r=d.slice(i+1);this.input.val(d.slice(0,i));if(r.length==0){return this.chomp()}return r},unchomp:function(e){d=this.input.val();if(!d){this.input.val(e)}else{this.input.val(d+" "+e)}},handleInput:function(g,f){if(f==""){return}if(f[0]!="/"){if(!this.client.cchannel){return}f=(g.shiftKey?"/npmsg ":"/say ")+f}f=f.slice(1);bits=f.split(" ");cmdn=bits.shift();ens=this.client.cchannel.info.namespace;etarget=ens;if(bits[0]){hash=bits[0][0];if((hash=="#"||hash=="@")&&bits[0].length>1){etarget=this.client.format_ns(bits.shift())}}arg=bits.join(" ");this.client.trigger("cmd."+cmdn+".wsc",{name:"cmd",cmd:cmdn,args:arg,target:etarget,ns:ens})},};b.init(a);return b}(function(a){a("*").hover(function(){a(this).data("hover",true)},function(){a(this).data("hover",false)});a.fn.wsc=function(e,b){client=a(window).data("wscclient");if(e=="init"||client===undefined){if(client==undefined){client=wsc_client(a(this),b,a.browser.mozilla);a(window).resize(client.resizeUI);a(window).focus(function(){client.control.focus()})}a(window).data("wscclient",client)}if(e!="init"&&e!=undefined){pieces=e.split(".");o=client;for(i in pieces){p=pieces[i];if(p in o){o=o[p]}else{return this}}o(a(this),b)}return this}})(jQuery);